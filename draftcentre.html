<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Hockey Draftcentre</title>
    <style>
        /* --- General Styles --- */
        :root {
            --primary-color: #003366;
            --secondary-color: #0055a4; /* Slightly lighter blue */
            --accent-color: #ffd700; /* Gold */
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --light-text: #f8f9fa;
            --border-color: #dee2e6;
            --hover-bg: #e9ecef;
            --success-bg: #d1e7dd;
            --success-border: #a3cfbb;
            --info-bg: #cff4fc;
            --info-border: #9eeaf9;
            --drafted-bg: #e9ecef;
            --drafted-text: #6c757d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0; /* Remove body padding */
            background-color: var(--light-bg);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1300px; /* Wider container */
            margin: 0 auto;
            padding: 15px; /* Consistent padding */
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
            flex-grow: 1; /* Allow container to grow */
        }

        h1, h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            margin-top: 1.5rem; /* Add top margin */
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }

        /* --- Buttons & Inputs --- */
        button, input, select, .btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.9rem;
            margin-right: 0.5rem; /* Reduced margin */
            margin-bottom: 0.5rem; /* Add bottom margin for wrapping */
            background-color: #fff;
            transition: all 0.2s ease-in-out;
            vertical-align: middle; /* Align items better */
        }
        input[type="text"], input[type="password"] {
            width: 200px; /* Default width */
            max-width: 100%; /* Allow shrinking */
        }
        select {
            min-width: 150px;
        }
        button, .btn {
            cursor: pointer;
            background-color: var(--primary-color);
            color: var(--light-text);
            border-color: var(--primary-color);
        }
        button:hover, .btn:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        button:disabled, .btn:disabled {
            background-color: #cccccc;
            border-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn.secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn.secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .btn.danger {
             background-color: #dc3545;
             border-color: #dc3545;
        }
        .btn.danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        a.btn { /* Style links as buttons */
            text-decoration: none;
            display: inline-block;
        }

        /* --- Layout Sections --- */
        .auth-container {
            background-color: #fff;
            padding: 1rem 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
        }
        #auth-status {
            margin: 0.5rem 0 0 0;
            font-style: italic;
            color: #6c757d;
        }
        .league-info {
            background-color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px;
        }
        .league-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        .league-details { color: #6c757d; font-size: 0.9rem; }

        .league-selection-area {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .draft-area {
            display: grid;
            grid-template-columns: 1fr; /* Default single column */
            gap: 1.5rem;
        }

        /* Grid layout for larger screens */
        @media (min-width: 992px) {
            .draft-area {
                grid-template-columns: repeat(2, 1fr); /* Two columns */
            }
            .available-players-section {
                grid-column: 1 / 2; /* Span first column */
            }
            .drafted-players-section {
                grid-column: 2 / 3; /* Span second column */
            }
             .full-width-section {
                grid-column: 1 / -1; /* Span both columns */
            }
        }

        .card { /* Card styling for sections */
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem; /* Space below cards */
        }

        .controls-section, .status-section, .action-buttons {
             grid-column: 1 / -1; /* Span full width */
        }

        /* --- Controls & Filters --- */
        .controls-section .controls-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
             gap: 1rem;
             align-items: center;
        }
        .search-container, .position-filter-container, .view-options-container {
            margin-bottom: 0; /* Remove bottom margin as grid handles gap */
        }

        #searchInput { width: 100%; box-sizing: border-box; } /* Full width search */

        .position-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .position-filter button {
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
            background-color: var(--light-bg);
            border-color: var(--border-color);
            color: var(--dark-text);
        }
        .position-filter button:hover {
            background-color: var(--hover-bg);
        }
        .position-filter button.active {
            background-color: var(--primary-color);
            color: var(--light-text);
            border-color: var(--primary-color);
        }

        .view-options-container label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        input[type="checkbox"] { margin-right: 5px; }

        .drafted-team-filter {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* Wrap on small screens */
        }

        /* Commissioner Toggle */
        .commissioner-controls {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: #fff3cd; /* Light yellow */
            border: 1px solid #ffeeba;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .commissioner-controls strong { color: #856404; }

        .commish-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .commish-toggle-container label { font-weight: normal; cursor: pointer; }
        /* Basic Toggle Switch Style */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px; /* Smaller switch */
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- Tables --- */
        .table-container {
            overflow-x: auto; /* Horizontal scroll on small screens */
            max-height: 450px; /* Max height */
            overflow-y: auto; /* Vertical scroll */
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            background-color: #fff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0; /* Remove bottom margin */
        }
        th, td {
            padding: 0.6rem 0.75rem; /* Adjusted padding */
            border: none; /* Remove cell borders */
            border-bottom: 1px solid var(--border-color); /* Use bottom border */
            text-align: left;
            font-size: 0.85rem; /* Slightly smaller font */
            white-space: nowrap; /* Prevent text wrapping */
        }
        th {
            background-color: var(--light-bg);
            position: sticky;
            top: 0;
            cursor: pointer;
            font-weight: 600; /* Bolder headers */
             z-index: 1; /* Keep header above scrolling content */
        }
        th:hover { background-color: var(--hover-bg); }
        tbody tr:last-child td { border-bottom: none; } /* Remove border on last row */
        tbody tr:hover { background-color: var(--hover-bg); }

        th.sorted-asc::after { content: " ▲"; font-size: 0.8em; }
        th.sorted-desc::after { content: " ▼"; font-size: 0.8em; }

        tr.drafted {
            background-color: var(--drafted-bg) !important; /* Use !important if needed */
            color: var(--drafted-text);
        }
        tr.drafted .draft-button { /* Hide draft button on drafted rows */
            visibility: hidden;
        }
        tr.drafted td { text-decoration: line-through; }

        td .draft-button, td .remove-button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        td .remove-button {
             background-color: #dc3545;
             border-color: #dc3545;
             color: white;
        }
        td .remove-button:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        /* --- Current Drafter & Status --- */
        .status-section {
            display: flex;
            justify-content: space-between; /* Align items */
            align-items: center;
            flex-wrap: wrap; /* Wrap on small screens */
            gap: 1rem;
        }
        .current-drafter {
            background-color: var(--info-bg);
            border-left: 4px solid var(--info-border);
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            font-size: 0.95rem;
            flex-grow: 1; /* Allow it to take available space */
            margin-bottom: 0; /* Remove bottom margin */
        }
        .current-drafter.my-turn {
            background-color: var(--success-bg);
            border-left-color: var(--success-border);
        }
        .current-drafter p { margin: 0; }
        #start-draft-btn { margin-bottom: 0; } /* Align with status */


        /* --- Action Buttons --- */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: flex-end; /* Align buttons right */
        }
        .action-buttons button, .action-buttons a.btn {
            padding: 0.6rem 1rem;
            margin-top: 0; /* Remove top margin */
        }


        /* --- Instructions --- */
        .instructions {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .instructions summary { cursor: pointer; font-weight: bold; }
        .instructions ol { margin-top: 0.5rem; padding-left: 20px; }


        /* --- Chat --- */
        .chat-container {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 320px; /* Slightly wider */
            max-width: 90vw; /* Max width on small screens */
            max-height: 80vh; /* Max height */
            height: 450px; /* Taller chat */
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px 5px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out; /* Smooth transition */
        }
        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--primary-color);
        }
        .chat-header span:first-child { font-weight: bold; }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background-color: white;
        }
        .chat-input input {
            flex-grow: 1;
            margin-right: 10px;
            border-radius: 15px; /* Rounded input */
            padding: 0.4rem 0.8rem;
        }
        .chat-input button {
            border-radius: 15px; /* Rounded button */
            padding: 0.4rem 0.8rem;
        }

        .chat-message { margin-bottom: 12px; line-height: 1.4; }
        .chat-user {
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        .user-avatar {
            width: 24px; height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            background-color: #eee; /* Placeholder color */
        }
        .chat-time { font-size: 0.75em; color: #999; margin-left: 8px; font-weight: normal; }
        .chat-text {
            background-color: white;
            padding: 8px 12px;
            border-radius: 10px;
            display: inline-block;
            max-width: 95%;
            word-wrap: break-word;
            margin-left: 32px; /* Align with avatar */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            font-size: 0.9rem;
        }
        .chat-system {
            text-align: center; color: #666; font-style: italic;
            margin: 10px 0; font-size: 0.85em;
        }

        .chat-container.minimized {
             transform: translateY(calc(100% - 45px)); /* Adjust based on header height */
             box-shadow: none;
        }
        .chat-container.minimized .chat-messages,
        .chat-container.minimized .chat-input { display: none; }


        /* --- Utilities & Misc --- */
        .hidden { display: none !important; } /* Use important if needed */

        .loader {
            display: flex; justify-content: center; align-items: center;
            height: 100px; width: 100%;
        }
        .loader::after {
            content: " "; display: block;
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            border-color: var(--primary-color) transparent var(--primary-color) transparent;
            animation: loader 1.2s linear infinite;
        }
        @keyframes loader {
            0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed; top: 20px; right: 20px;
            background-color: var(--primary-color); color: white;
            padding: 10px 15px; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: fadeInOut 5s forwards;
            font-size: 0.9rem;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }

        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Specific League Selection Styling */
         #league-list .league-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap; /* Allow wrapping */
            gap: 10px;
        }
        #league-list .league-item:last-child { border-bottom: none; }
        #league-list .league-name { font-size: 1.1rem; }
        #league-list .league-details { font-size: 0.85rem; }
        #league-list .btn { margin-top: 0; padding: 0.4rem 0.8rem; font-size: 0.85rem;}

        /* Responsive adjustments */
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.3rem; }
            .controls-section .controls-grid { grid-template-columns: 1fr; } /* Stack controls */
            .search-container, .position-filter-container, .view-options-container { margin-bottom: 1rem; }
            .league-info { flex-direction: column; align-items: flex-start; }
            .table-container { max-height: 350px; } /* Reduce height on smaller screens */
            th, td { font-size: 0.8rem; padding: 0.5rem 0.6rem; }
            /* Optionally hide less important table columns */
             .hide-mobile { display: none; }
             th:nth-child(4), td:nth-child(4), /* GP */
             th:nth-child(8), td:nth-child(8), /* W */
             th:nth-child(9), td:nth-child(9)  /* SO */
             {
                 /* Example: Hiding GP, W, SO on small screens */
                /* display: none; */
             }
        }
         @media (max-width: 576px) {
             .chat-container { width: 95vw; }
             .action-buttons { justify-content: center; }
             .action-buttons button, .action-buttons a.btn { width: 100%; text-align: center; margin-bottom: 0.5rem;}
             .drafted-team-filter { flex-direction: column; align-items: stretch; }
             .drafted-team-filter select { width: 100%; }
         }

    </style>
</head>

<body>
    <header class="auth-container">
        <button id="login-btn" class="btn">Sign in with Google</button>
        <button id="logout-btn" class="btn secondary hidden">Sign Out</button>
        <div id="auth-status">You are not signed in</div>
    </header>

    <main class="container">
        <div id="content-container" class="hidden">
            <div id="league-info" class="league-info hidden">
                <div>
                    <div class="league-name" id="league-name">League Name Loading...</div>
                    <div class="league-details">
                        <span id="league-team-count">X Teams</span>
                    </div>
                </div>
                <a href="manage-leagues.html" class="btn secondary">Manage Leagues</a>
            </div>

            <div id="league-select-container" class="league-selection-area">
                <h2>Select a League</h2>
                <p>Please select a league or create/join a new one:</p>
                <div id="league-list"><div class="loader"></div></div>
                 <div class="action-buttons" style="justify-content: flex-start; margin-top: 1rem;">
                    <a href="manage-leagues.html" class="btn">Create or Join League</a>
                 </div>
            </div>

            <div id="draft-container" class="hidden">
                <div class="full-width-section">
                    <h1>Fantasy Hockey Draftcentre</h1>
                     <!-- Issue 5: Update disclaimer text -->
                    <p style="margin-top: -10px; color: #666; font-size: 0.9rem;">Stats shown are from the current regular season</p>
                </div>

                <!-- Commissioner Controls - Placed near the top -->
                <div id="commissioner-controls" class="commissioner-controls card hidden full-width-section">
                    <strong>Commissioner Mode:</strong>
                    <div class="commish-toggle-container">
                        <label class="switch">
                            <input type="checkbox" id="commissioner-mode-toggle">
                            <span class="slider"></span>
                        </label>
                        <label for="commissioner-mode-toggle">Draft for any team</label>
                    </div>
                    <span style="font-size: 0.85rem; color: #6c757d;">(Allows drafting when it's not your turn, assigns pick to the current team)</span>
                </div>

                <div class="full-width-section">
                    <div class="instructions">
                         <details>
                             <summary><strong>How to use the Draftcentre</strong> (click to expand)</summary>
                             <ol>
                                 <li><strong>Browse & Search:</strong> Use filters and search to find available players.</li>
                                 <li><strong>Sort:</strong> Click column headers to sort players.</li>
                                 <li><strong>Draft:</strong> Click the "Draft" button when it's your turn (or if Commissioner Mode is on).</li>
                                 <li><strong>View Picks:</strong> See drafted players in the "Drafted Players" section.</li>
                                 <li><strong>Chat:</strong> Discuss picks with league members in the chat window.</li>
                             </ol>
                             <p><em>Note: The commissioner can start the draft and enable Commissioner Mode to manage picks.</em></p>
                         </details>
                    </div>
                </div>

                 <!-- Status Section: Current Drafter & Start Button -->
                <div class="status-section card full-width-section">
                    <div id="current-drafter" class="current-drafter hidden">
                        <p><strong>Current Pick:</strong> <span id="current-drafter-name">Waiting to start draft...</span></p>
                    </div>
                    <button id="start-draft-btn" class="btn hidden">Start Draft</button>
                </div>

                <!-- Control Section: Search, Filters, Options -->
                <div class="controls-section card full-width-section">
                    <div class="controls-grid">
                         <div class="search-container">
                            <label for="searchInput" class="visually-hidden">Search Players</label> <!-- Hidden label for accessibility -->
                            <input type="text" id="searchInput" placeholder="Search by player name..." oninput="filterPlayers()">
                         </div>
                         <div class="position-filter-container">
                            <div class="position-filter">
                                <button class="position-btn active" data-position="all">All</button>
                                <button class="position-btn" data-position="C">C</button>
                                <button class="position-btn" data-position="LW">LW</button>
                                <button class="position-btn" data-position="RW">RW</button>
                                <button class="position-btn" data-position="D">D</button>
                                <button class="position-btn" data-position="G">G</button>
                            </div>
                        </div>
                        <div class="view-options-container">
                            <label for="showDrafted"><input type="checkbox" id="showDrafted" onchange="filterPlayers()"> Show Drafted Players</label>
</label>
</div>
</div>
</div>

<!-- Available Players Section -->
<div class="available-players-section">
<div class="card">
<h2>Available Players</h2>
<div class="table-container">
 <table id="playerTable">
     <thead>
         <tr>
             <th data-sort="fullName">Name</th>
             <th data-sort="position">Pos</th>
             <th data-sort="teamAbbreviation">Team</th>
             <th data-sort="gamesPlayed" class="hide-mobile">GP</th>
             <th data-sort="goals" class="skater-stat">G</th>
             <th data-sort="assists" class="skater-stat">A</th>
             <th data-sort="points" class="skater-stat">PTS</th>
             <th data-sort="wins" class="goalie-stat hide-mobile">W</th>
             <th data-sort="shutouts" class="goalie-stat hide-mobile">SO</th>
             <th>Action</th>
         </tr>
     </thead>
     <tbody id="playerTableBody">
         <!-- Player data will be loaded here -->
         <tr><td colspan="10" style="text-align: center;"><div class="loader"></div></td></tr>
     </tbody>
 </table>
</div>
</div>
</div>

<!-- Drafted Players Section -->
<div class="drafted-players-section">
<div class="card">
<h2>Drafted Players</h2>
<div class="drafted-team-filter">
<label for="draftedTeamFilter">Show Team:</label>
<select id="draftedTeamFilter" onchange="filterDraftedPlayers()">
    <option value="all">All Teams</option>
    <!-- Team options will be dynamically added -->
</select>
</div>
<div class="table-container">
<table id="draftedTable">
    <thead>
         <tr>
             <th data-sort="draftNumber" style="width: 5%;">Pick#</th>
             <th data-sort="Player">Name</th>
            <th data-sort="Position">Pos</th>
            <th data-sort="NHL Team" class="hide-mobile">NHL Team</th>
            <th data-sort="Team">Fantasy Team</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="draftedTableBody">
        <!-- Drafted players will be shown here -->
        <tr><td colspan="6" style="text-align: center;">Loading drafted players...</td></tr>
    </tbody>
</table>
</div>
</div>
</div>

<!-- Action Buttons -->
<div class="action-buttons full-width-section">
<a href="#" id="back-to-league-link" class="btn secondary hidden">Back to League Details</a>
<!-- Start Draft button moved to status section -->
</div>
</div> <!-- End #draft-container -->
</div> <!-- End #content-container -->
</main>

<!-- Chat remains floating -->
<div id="chat-container" class="chat-container hidden minimized">
<div class="chat-header" id="chat-header">
<span>Draft Chat</span>
<span id="chat-toggle">+</span>
</div>
<div class="chat-messages" id="chat-messages">
<!-- Chat messages will appear here -->
</div>
<div class="chat-input">
<input type="text" id="chat-input" placeholder="Type a message...">
<button id="chat-send" class="btn">Send</button>
</div>
</div>

<script src="firebaseConfig.js"></script>
<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, get, update, off, query, limitToLast, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"; // Added serverTimestamp

// Placeholder Firebase configuration
const fallbackFirebaseConfig = {
apiKey: "PLACEHOLDER_API_KEY",
authDomain: "playofffantasyhockey.firebaseapp.com",
databaseURL: "https://playofffantasyhockey-default-rtdb.firebaseio.com",
projectId: "playofffantasyhockey",
storageBucket: "playofffantasyhockey.appspot.com",
messagingSenderId: "PLACEHOLDER_SENDER_ID",
appId: "PLACEHOLDER_APP_ID"
};

const app = initializeApp(window.firebaseConfig || fallbackFirebaseConfig);
const auth = getAuth();
setPersistence(auth, browserSessionPersistence).catch(console.error);
const provider = new GoogleAuthProvider();
const database = getDatabase();

// --- Global State ---
let currentUser = null;
let allPlayers = [];
let draftedPlayers = []; // Holds { ..., firebaseKey: '...', draftNumber: X }
let leagueData = null;
let leagueId = null;
let currentPositionFilter = 'all';
let currentSortColumn = null; // For available players table
let currentSortDirection = 'asc'; // For available players table
let currentTeams = {}; // { uid: { name, isCommissioner, photoURL }, ... }
let isCommissioner = false;
let commissionerModeActive = false; // Issue 4: State for the toggle
let chatListeners = {};
let playerListeners = {};
let draftStatusListener = null; // Ref to the draft status listener

// --- DOM Elements ---
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const authStatus = document.getElementById('auth-status');
const contentContainer = document.getElementById('content-container');
const leagueSelectContainer = document.getElementById('league-select-container');
const leagueListEl = document.getElementById('league-list');
const draftContainer = document.getElementById('draft-container');
const leagueInfoContainer = document.getElementById('league-info');
const leagueNameEl = document.getElementById('league-name');
const leagueTeamCountEl = document.getElementById('league-team-count');
const draftedTeamFilter = document.getElementById('draftedTeamFilter');
const startDraftBtn = document.getElementById('start-draft-btn');
const currentDrafterContainer = document.getElementById('current-drafter');
const currentDrafterName = document.getElementById('current-drafter-name');
const playerTableBody = document.getElementById('playerTableBody');
const draftedTableBody = document.getElementById('draftedTableBody');
const chatContainer = document.getElementById('chat-container');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const chatHeader = document.getElementById('chat-header');
const chatToggle = document.getElementById('chat-toggle');
const backToLeagueLink = document.getElementById('back-to-league-link');
const commissionerControls = document.getElementById('commissioner-controls'); 
const commissionerModeToggle = document.getElementById('commissioner-mode-toggle');

// --- Initialization ---
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('league')) {
leagueId = urlParams.get('league');
}

// --- Auth ---
onAuthStateChanged(auth, (user) => {
if (user) {
currentUser = user;
loginBtn.classList.add('hidden');
logoutBtn.classList.remove('hidden');
authStatus.textContent = `Signed in as ${user.displayName}`;
contentContainer.classList.remove('hidden');
setupAuthPersistence();
storeUserProfile(user);

if (leagueId) {
loadLeague(leagueId);
backToLeagueLink.href = `league.html?id=${leagueId}`;
backToLeagueLink.classList.remove('hidden');
} else {
loadUserLeagues();
backToLeagueLink.classList.add('hidden');
}
} else {
currentUser = null;
localStorage.removeItem('fantasy_hockey_user');
loginBtn.classList.remove('hidden');
logoutBtn.classList.add('hidden');
authStatus.textContent = 'You are not signed in';
contentContainer.classList.add('hidden');
chatContainer.classList.add('hidden');
backToLeagueLink.classList.add('hidden');
commissionerControls.classList.add('hidden'); // Hide commish controls on logout
cleanupListeners();
resetUIState(); // Clear dynamic data
}
});

loginBtn.addEventListener('click', () => {
signInWithPopup(auth, provider).catch(error => {
console.error("Auth error:", error);
authStatus.textContent = `Error: ${error.message}`;
showNotification(`Sign-in Error: ${error.message}`, 7000);
});
});

logoutBtn.addEventListener('click', () => {
signOut(auth).then(() => {
window.location.reload(); // Force reload for clean state
}).catch(error => {
console.error("Sign out error:", error);
showNotification(`Sign-out Error: ${error.message}`, 7000);
});
});

function storeUserProfile(user) {
const userRef = ref(database, `users/${user.uid}/profile`);
update(userRef, { // Use update to avoid overwriting other potential data
uid: user.uid,
displayName: user.displayName,
email: user.email,
photoURL: user.photoURL || null,
lastLogin: serverTimestamp() // Use server timestamp
}).catch(error => console.error("Error storing user profile:", error));
}

function resetUIState() {
// Clear tables, dropdowns, etc.
leagueListEl.innerHTML = '';
if(playerTableBody) playerTableBody.innerHTML = '';
if(draftedTableBody) draftedTableBody.innerHTML = '';
if(draftedTeamFilter) draftedTeamFilter.innerHTML = '<option value="all">All Teams</option>';
if(leagueNameEl) leagueNameEl.textContent = '';
if(leagueTeamCountEl) leagueTeamCountEl.textContent = '';
if(currentDrafterName) currentDrafterName.textContent = 'Draft not started';
if(currentDrafterContainer) currentDrafterContainer.classList.add('hidden');
if(startDraftBtn) startDraftBtn.classList.add('hidden');
// Reset global vars
allPlayers = [];
draftedPlayers = [];
leagueData = null;
leagueId = null; // Reset leagueId as well
currentTeams = {};
isCommissioner = false;
commissionerModeActive = false;
}

// --- League Loading & Selection ---
function loadUserLeagues() {
if (!currentUser) return;
resetUIState(); // Clear previous league state before loading list
leagueSelectContainer.classList.remove('hidden');
draftContainer.classList.add('hidden');
leagueInfoContainer.classList.add('hidden');
leagueListEl.innerHTML = '<div class="loader"></div>';

const userLeaguesRef = ref(database, `users/${currentUser.uid}/leagues`);
get(userLeaguesRef).then((snapshot) => {
leagueListEl.innerHTML = ''; // Clear loader
if (snapshot.exists()) {
const leagues = snapshot.val();
if (typeof leagues === 'object' && leagues !== null) {
const leagueEntries = Object.values(leagues); // Get array of league objects
if (leagueEntries.length > 0) {
 leagueEntries
     .sort((a, b) => (a.name || '').localeCompare(b.name || '')) // Sort by name
     .forEach(league => {
         if (league && league.leagueId && league.name) {
             const leagueItem = document.createElement('div');
             leagueItem.className = 'league-item';
             leagueItem.innerHTML = `
                 <div>
                     <div class="league-name">${league.name}</div>
                     <div class="league-details">Role: ${league.role || 'Member'}</div>
                 </div>
                 <a href="draftcentre.html?league=${league.leagueId}" class="btn">Open Draft</a>
             `;
             leagueListEl.appendChild(leagueItem);
         } else {
             console.warn("Skipping invalid league data:", league);
         }
     });
} else {
  leagueListEl.innerHTML = '<p>You haven\'t joined any leagues yet.</p>';
}
} else {
console.error("User leagues data is not in the expected format:", leagues);
leagueListEl.innerHTML = `<p>Could not load league data.</p>`;
}
} else {
leagueListEl.innerHTML = `<p>You haven\'t joined any leagues yet.</p>`;
}
}).catch((error) => {
console.error("Error loading leagues:", error);
leagueListEl.innerHTML = `<p>Error loading leagues: ${error.message}</p>`;
showNotification(`Error loading your leagues: ${error.message}`, 7000);
});
}

function loadLeague(leagueIdToLoad) {
if (!currentUser || !leagueIdToLoad) {
console.error("Cannot load league without user or league ID");
loadUserLeagues();
return;
}
leagueId = leagueIdToLoad; // Set global leagueId
console.log(`Loading league: ${leagueId}`);
resetUIState(); // Clear previous league state

const leagueRef = ref(database, `leagues/${leagueId}`);
get(leagueRef).then((snapshot) => {
if (snapshot.exists()) {
leagueData = snapshot.val();
console.log("League data loaded:", leagueData);

if (!leagueData.teams || !leagueData.teams[currentUser.uid]) {
    console.warn("League teams object:", leagueData.teams);
    console.warn("Current user UID:", currentUser.uid);
    handleNoAccessToLeague(leagueData);
    return;
}

isCommissioner = leagueData.teams[currentUser.uid]?.isCommissioner ?? false;
console.log(`User is commissioner: ${isCommissioner}`);

showDraftInterface();
window.addEventListener('beforeunload', handlePageLeave);
setupLeagueListeners(); // Setup real-time updates
loadPlayerData(); // Load static player list
} else {
console.error(`League with ID ${leagueId} not found.`);
showNotification("League not found.");
leagueId = null;
cleanupListeners();
loadUserLeagues(); // Go back to selection
}
}).catch((error) => {
console.error(`Error loading league ${leagueId}:`, error);
showNotification(`Error loading league: ${error.message}`, 7000);
leagueId = null;
cleanupListeners();
loadUserLeagues();
});
}

function handlePageLeave(event) {
// Best effort notification - not guaranteed
if (currentUser && leagueId && leagueData?.teams?.[currentUser.uid]) {
const presenceRef = ref(database, `leagues/${leagueId}/presence/${currentUser.uid}`);
update(presenceRef, { online: false, lastSeen: serverTimestamp() }); // Indicate offline
console.log("Attempting to mark user as offline (not guaranteed)");
}
}

// --- Draft Interface Setup & Updates ---
function showDraftInterface() {
leagueSelectContainer.classList.add('hidden');
draftContainer.classList.remove('hidden');
leagueInfoContainer.classList.remove('hidden');
chatContainer.classList.remove('hidden'); // Show chat

leagueNameEl.textContent = leagueData?.name ?? 'League Name';
const teamCount = Object.keys(leagueData?.teams ?? {}).length;
leagueTeamCountEl.textContent = `${teamCount} Teams`;

populateTeamFilter();

// Issue 4: Setup Commissioner Controls
setupCommissionerControls();

// Listen for draft status changes
if (draftStatusListener) {
// Correct way to remove specific listener: use off() with ref, eventType, and the listener function itself
const draftStatusRef = ref(database, `leagues/${leagueId}/draftStatus`);
off(draftStatusRef, 'value', draftStatusListener);
console.log("Removed previous draft status listener.");
}
const draftStatusRef = ref(database, `leagues/${leagueId}/draftStatus`);
draftStatusListener = onValue(draftStatusRef, (snapshot) => { // Store the listener function
const draftStatus = snapshot.val();
console.log("Draft status updated:", draftStatus);
leagueData.draftStatus = draftStatus; // Update local state

updateDraftStatusUI(draftStatus); // Update UI based on new status
filterPlayers(); // Re-filter players to update button states

}, (error) => {
console.error("Error reading draft status:", error);
currentDrafterName.textContent = 'Error loading status';
filterPlayers(); // Still filter, buttons likely disabled
showNotification("Error syncing draft status.", 7000);
});
console.log("Added draft status listener.");

startDraftBtn.removeEventListener('click', startDraft); // Remove previous listener
startDraftBtn.addEventListener('click', startDraft);
}

// Issue 4: Setup commissioner controls visibility and toggle listener
function setupCommissionerControls() {
    if (isCommissioner) {
        commissionerControls.classList.remove('hidden');
        commissionerModeToggle.checked = commissionerModeActive; // Set initial state
        commissionerModeToggle.removeEventListener('change', handleCommissionerToggle); // Remove old listener
        commissionerModeToggle.addEventListener('change', handleCommissionerToggle);
    } else {
        commissionerControls.classList.add('hidden');
        commissionerModeActive = false; // Ensure mode is off if not commissioner
    }
}
// Issue 4: Handle commissioner toggle change
function handleCommissionerToggle() {
    commissionerModeActive = commissionerModeToggle.checked;
    console.log(`Commissioner Mode ${commissionerModeActive ? 'Enabled' : 'Disabled'}`);
    // Re-filter players to update draft button enabled state based on the new mode
    filterPlayers();
    // Optional: Show notification
    showNotification(`Commissioner Mode ${commissionerModeActive ? 'ON' : 'OFF'}`, 2000);
}

function updateDraftStatusUI(draftStatus) {
    const draftIsActive = draftStatus?.active ?? false;

    if (draftIsActive) {
        startDraftBtn.classList.add('hidden');
        currentDrafterContainer.classList.remove('hidden');

        const currentDrafterUid = draftStatus.currentDrafter;
        const currentRound = draftStatus.round || 1;
        const pickNumber = draftStatus.pickNumber || '?'; // Overall pick number

        if (currentDrafterUid && currentTeams[currentDrafterUid]) {
            const drafterTeamName = currentTeams[currentDrafterUid].name;
            let drafterText = `<strong>${drafterTeamName}</strong> (Round ${currentRound}, Pick ${pickNumber})`;

            if (currentDrafterUid === currentUser.uid) {
                currentDrafterContainer.classList.add('my-turn');
                drafterText += ' - <strong>Your Turn!</strong>';
            } else {
                currentDrafterContainer.classList.remove('my-turn');
            }
            currentDrafterName.innerHTML = drafterText; // Use innerHTML for bolding
        } else {
            console.warn("Current drafter UID not found in teams data:", currentDrafterUid);
            currentDrafterName.textContent = `Waiting... (Round ${currentRound})`;
            currentDrafterContainer.classList.remove('my-turn');
        }
    } else {
        // Draft is not active
        if (isCommissioner) {
            startDraftBtn.classList.remove('hidden'); // Show start button if commissioner
        } else {
            startDraftBtn.classList.add('hidden');
        }
        currentDrafterContainer.classList.add('hidden');
        currentDrafterName.textContent = 'Draft not started';
        currentDrafterContainer.classList.remove('my-turn');
    }
}

// --- Firebase Listeners ---
function setupLeagueListeners() {
cleanupListeners(); // Clean up ALL old listeners first
console.log(`Setting up listeners for league: ${leagueId}`);

// Listener 1: Drafted Players changes
const draftedPlayersRef = ref(database, `leagues/${leagueId}/draftedPlayers`);
playerListeners.draftedPlayers = onValue(draftedPlayersRef, (snapshot) => {
console.log("Drafted players data received.");
const draftedData = snapshot.val() || {};
// Sort by timestamp to determine draft order/number reliably
draftedPlayers = Object.entries(draftedData)
.map(([key, player]) => ({ ...player, firebaseKey: key })) // Add firebaseKey
.sort((a, b) => (a.draftedAt || 0) > (b.draftedAt || 0) ? 1 : -1) // Sort by timestamp
.map((player, index) => ({ ...player, draftNumber: index + 1 })); // Assign draft number

filterDraftedPlayers(); // Update 'Drafted Players' table
filterPlayers(); // Re-filter available players
}, (error) => {
console.error("Error reading drafted players:", error);
showNotification("Error loading drafted players list.", 7000);
});
console.log("Added drafted players listener.");

// Listener 2: League Teams changes
const teamsRef = ref(database, `leagues/${leagueId}/teams`);
playerListeners.teams = onValue(teamsRef, (snapshot) => {
console.log("Teams data received.");
const newTeamsData = snapshot.val() || {};
// Store basic user info from teams for chat/display efficiency
const simplifiedTeams = {};
Object.entries(newTeamsData).forEach(([uid, team]) => {
simplifiedTeams[uid] = {
name: team.name || `Team ${uid.substring(0,4)}`,
isCommissioner: team.isCommissioner || false,
photoURL: team.owner?.photoURL || null // Get photo from owner profile if exists
};
});

detectJoinLeave(currentTeams, simplifiedTeams); // Detect presence changes based on simplified data
currentTeams = simplifiedTeams; // Update global teams object

populateTeamFilter(); // Update drafted players filter dropdown
updateDraftStatusUI(leagueData?.draftStatus); // Refresh drafter name potentially
}, (error) => {
console.error("Error reading league teams:", error);
showNotification("Error loading team information.", 7000);
});
console.log("Added teams listener.");

// Listener 3: Chat messages
const chatRef = ref(database, `leagues/${leagueId}/chat`);
const chatQuery = query(chatRef, limitToLast(50)); // Load recent + listen for new
chatListeners.chat = onValue(chatQuery, (snapshot) => {
console.log("Chat data received.");
updateChatMessages(snapshot.val() || {});
}, (error) => {
console.error("Error reading chat messages:", error);
if(chatMessages) chatMessages.innerHTML = '<div class="chat-system error-message">Error loading chat messages.</div>';
});
console.log("Added chat listener.");

// Listener 4: Online Presence (listen to a presence node)
// Update user's own presence on connect/disconnect
const presenceRef = ref(database, `leagues/${leagueId}/presence/${currentUser.uid}`);
const connectedRef = ref(database, '.info/connected');
playerListeners.presence = onValue(connectedRef, (snap) => {
if (snap.val() === true) {
set(presenceRef, { online: true, lastSeen: serverTimestamp() });
// On disconnect, set presence to offline
presenceRef.onDisconnect().set({ online: false, lastSeen: serverTimestamp() });
console.log("User presence set to online.");
}
});
console.log("Added presence listener.");
// Note: We might need another listener on the main `presence` node to display other users' status if desired.

// Listener 5: Draft Status (already set up in showDraftInterface, managed by draftStatusListener)
}

function detectJoinLeave(previousTeams, newTeams) {
if (!currentUser || Object.keys(previousTeams).length === 0) return; // Skip initial load

const prevIds = new Set(Object.keys(previousTeams));
const newIds = new Set(Object.keys(newTeams));

newIds.forEach(uid => {
if (!prevIds.has(uid) && uid !== currentUser.uid) {
const joinerName = newTeams[uid]?.name ?? 'Someone';
console.log(`${joinerName} detected joining.`);
addChatMessage({ type: 'system', text: `${joinerName} joined the draft`, timestamp: serverTimestamp() });
}
});

prevIds.forEach(uid => {
if (!newIds.has(uid) && uid !== currentUser.uid) { // Don't announce self leaving due to page close
const leaverName = previousTeams[uid]?.name ?? 'Someone';
console.log(`${leaverName} detected leaving.`);
// Don't announce leaves from here as it's often due to refresh/close. Rely on presence or explicit kick messages.
// addChatMessage({ type: 'system', text: `${leaverName} left the draft`, timestamp: serverTimestamp() });
}
});
}

// --- UI Updates ---
function populateTeamFilter() {
const currentFilterValue = draftedTeamFilter.value;
draftedTeamFilter.innerHTML = '<option value="all">All Teams</option>';

if (currentTeams && Object.keys(currentTeams).length > 0) {
const sortedTeams = Object.values(currentTeams).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
sortedTeams.forEach(team => {
// Use team NAME as value for filtering, as stored in draftedPlayer object
const option = document.createElement('option');
option.value = team.name || ''; // Ensure value is string
option.textContent = team.name || `Unnamed Team`;
if(option.value) { // Only add if name is not empty
draftedTeamFilter.appendChild(option);
}
});
}

const optionExists = [...draftedTeamFilter.options].some(opt => opt.value === currentFilterValue);
if (optionExists) {
draftedTeamFilter.value = currentFilterValue;
} else if (currentUser && currentTeams[currentUser.uid]?.name) {
draftedTeamFilter.value = currentTeams[currentUser.uid].name; // Default to user's team
} else {
draftedTeamFilter.value = 'all'; // Default to all
}
filterDraftedPlayers(); // Refresh drafted players list
}

// --- Player Data Handling ---
function loadPlayerData() {
if (allPlayers && allPlayers.length > 0) {
console.log("Player data already loaded.");
filterPlayers(); return;
}
console.log("Loading player data...");
if(playerTableBody) playerTableBody.innerHTML = `<tr><td colspan="10" style="text-align: center;"><div class="loader"></div></td></tr>`;

fetch('data/nhl_players.json')
.then(response => {
if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
return response.json();
})
.then(data => {
if (!Array.isArray(data)) throw new Error("Player data is not an array.");
console.log(`Loaded ${data.length} players.`);
allPlayers = data;
filterPlayers(); // Initial display
})
.catch(error => {
console.error('Error loading player data:', error);
showNotification('Error loading NHL player data. Check console.', 7000);
if(playerTableBody) playerTableBody.innerHTML = `<tr><td colspan="10" style="text-align: center; color: red;">Failed to load player data. ${error.message}</td></tr>`;
});
}

// --- Filtering & Rendering Players ---
function filterPlayers() { // Filters and renders the AVAILABLE players table
if (!allPlayers || allPlayers.length === 0 || !playerTableBody) return;

const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
const showDrafted = document.getElementById('showDrafted').checked;

let filtered = allPlayers;

// Apply position filter
if (currentPositionFilter !== 'all') {
filtered = filtered.filter(player => player.position === currentPositionFilter);
}

// Apply search filter
if (searchTerm) {
filtered = filtered.filter(player => (player.fullName || '').toLowerCase().includes(searchTerm));
}

// Get drafted player IDs (ensure player IDs are strings for comparison)
const draftedIdsSet = new Set(draftedPlayers.map(dp => dp.playerId?.toString()));

// Filter out drafted unless 'Show Drafted' is checked
if (!showDrafted) {
filtered = filtered.filter(player => !draftedIdsSet.has(player.id?.toString()));
}

// Apply sorting
if (currentSortColumn) {
filtered.sort((a, b) => {
let aValue = a[currentSortColumn];
let bValue = b[currentSortColumn];
const defaultStr = ''; const defaultNum = -Infinity; // Sort nulls/undefined low for numbers

if (typeof aValue === 'string' || typeof bValue === 'string') {
aValue = (aValue ?? defaultStr).toString().toLowerCase();
bValue = (bValue ?? defaultStr).toString().toLowerCase();
return currentSortDirection === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
} else {
aValue = Number(aValue ?? defaultNum);
bValue = Number(bValue ?? defaultNum);
return currentSortDirection === 'asc' ? aValue - bValue : bValue - aValue;
}
});
} else { // Default sort by name
filtered.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));
}

renderPlayerTable(filtered, draftedIdsSet);
}

function renderPlayerTable(playersToRender, draftedIdsSet) {
if (!playerTableBody) return;
playerTableBody.innerHTML = '';

if (playersToRender.length === 0) {
playerTableBody.innerHTML = `<tr><td colspan="10" style="text-align: center;">No players match filters.</td></tr>`;
return;
}

const draftIsActive = leagueData?.draftStatus?.active ?? false;
const isMyTurn = draftIsActive && leagueData?.draftStatus?.currentDrafter === currentUser?.uid;
// Check commissioner mode toggle as well
const iCanDraftAnyPlayer = draftIsActive && (isMyTurn || (isCommissioner && commissionerModeActive));

const fragment = document.createDocumentFragment();

playersToRender.forEach(player => {
const row = document.createElement('tr');
const playerIdStr = player.id?.toString();
const isDrafted = draftedIdsSet.has(playerIdStr);

row.classList.toggle('drafted', isDrafted); // Add/remove drafted class

// Button enabled if: I can draft *any* player AND this specific player is not drafted
const draftButtonEnabled = iCanDraftAnyPlayer && !isDrafted;

const formatStat = (val) => (val == null || val === "" || val === 0) ? '-' : val;
const position = player.position || 'N/A';
const fullName = player.fullName || 'N/A';
const team = player.teamAbbreviation || 'N/A';

// Use dataset for cleaner JS access
row.dataset.playerId = playerIdStr;
row.dataset.playerName = fullName;
row.dataset.playerPosition = position;
row.dataset.playerTeam = team;

row.innerHTML = `
<td>${fullName}</td>
<td>${position}</td>
<td>${team}</td>
<td class="hide-mobile">${formatStat(player.gamesPlayed)}</td>
<td class="skater-stat">${position !== 'G' ? formatStat(player.goals) : '-'}</td>
<td class="skater-stat">${position !== 'G' ? formatStat(player.assists) : '-'}</td>
<td class="skater-stat">${position !== 'G' ? formatStat(player.points) : '-'}</td>
<td class="goalie-stat hide-mobile">${position === 'G' ? formatStat(player.wins) : '-'}</td>
<td class="goalie-stat hide-mobile">${position === 'G' ? formatStat(player.shutouts) : '-'}</td>
                    <td>
                        <button class="draft-button btn" ${draftButtonEnabled ? '' : 'disabled'}>
                            ${isDrafted ? 'Drafted' : 'Draft'}
                        </button>
                    </td>
                `;
                fragment.appendChild(row);
            });

            playerTableBody.appendChild(fragment);

            // Add event listeners AFTER appending
            playerTableBody.querySelectorAll('.draft-button:not([disabled])').forEach(button => {
                // Remove potential old listeners before adding new ones
                button.removeEventListener('click', handleDraftClick);
                button.addEventListener('click', handleDraftClick);
            });
        }

        function handleDraftClick(event) {
            const button = event.target;
            const row = button.closest('tr'); // Get the parent row
            if (!row) return;

            // Disable button immediately
            button.disabled = true;
            button.textContent = 'Drafting...'; // Provide feedback

            const playerId = row.dataset.playerId;
            const playerName = row.dataset.playerName;
            const position = row.dataset.playerPosition;
            const nhlTeam = row.dataset.playerTeam;

            console.log(`Draft button clicked for ${playerName} (ID: ${playerId})`);
            draftPlayer(playerId, playerName, position, nhlTeam);
        }

        // --- Drafting Logic ---
        function draftPlayer(playerId, playerName, position, nhlTeam) {
            console.log(`Attempting draft for ${playerName}`);
            const draftIsActive = leagueData?.draftStatus?.active ?? false;
            if (!draftIsActive) {
                showNotification("The draft is not currently active.");
                filterPlayers(); // Refresh buttons
                return;
            }
            if (!currentUser) {
                showNotification("You must be logged in to draft.");
                filterPlayers();
                return;
            }

            const currentDrafterUid = leagueData.draftStatus.currentDrafter;
            const isMyTurn = currentDrafterUid === currentUser.uid;
            // Determine if commissioner mode allows drafting
            const commissionerDrafting = isCommissioner && commissionerModeActive;

            // Who is the pick assigned to?
            let teamUidToAssign = null;
            if (isMyTurn || commissionerDrafting) {
                // If it's my turn OR commissioner is overriding, the pick belongs to the *current* official drafter
                teamUidToAssign = currentDrafterUid;
            } else {
                showNotification("It's not your turn to draft.");
                filterPlayers(); // Re-enable button if wrongly disabled
                return;
            }

             const teamNameToAssign = currentTeams[teamUidToAssign]?.name;
             const drafterDisplayName = currentUser.displayName; // User performing the action

             if (!teamNameToAssign) {
                 console.error(`Cannot assign player: Team name not found for UID ${teamUidToAssign}`);
                 showNotification(`Error: Could not find team name for the current pick.`);
                 filterPlayers();
                 return;
             }

             // Check again if player already drafted (race condition mitigation)
             const latestDraftedIds = new Set(draftedPlayers.map(dp => dp.playerId?.toString()));
             if (latestDraftedIds.has(playerId?.toString())) {
                 showNotification(`${playerName} has already been drafted.`);
                 filterPlayers(); // Refresh table
                 return;
             }

             // Get current draft state details for the record
             const currentRound = leagueData.draftStatus.round ?? 1;
             const currentPickNumber = leagueData.draftStatus.pickNumber ?? 1; // Overall pick number

            // Create player record
            const draftedPlayerRecord = {
                playerId: playerId,
                Player: playerName,
                Position: position,
                "NHL Team": nhlTeam,
                Team: teamNameToAssign, // Fantasy Team Name
                teamUid: teamUidToAssign, // UID of team getting the player
                draftedByUid: currentUser.uid, // UID of user clicking button
                draftedByName: drafterDisplayName, // Name of user clicking button
                draftedAt: serverTimestamp(), // Use server time for consistency
                round: currentRound,
                pickNumber: currentPickNumber // Store overall pick number
            };
            console.log("Drafted player record:", draftedPlayerRecord);

            disableAllDraftButtons(); // Prevent multiple clicks

            // Save to Firebase
            const draftedPlayersRef = ref(database, `leagues/${leagueId}/draftedPlayers`);
            const newPlayerRef = push(draftedPlayersRef);

            set(newPlayerRef, draftedPlayerRecord).then(() => {
                console.log(`${playerName} successfully drafted for ${teamNameToAssign}.`);
                showNotification(`${playerName} drafted! (Pick ${currentPickNumber})`);

                // Add system chat message
                let chatMessageText;
                if (!isMyTurn && commissionerDrafting) {
                    chatMessageText = `${drafterDisplayName} (Commish) drafted ${playerName} for ${teamNameToAssign} (Pick ${currentPickNumber})`;
                } else {
                    chatMessageText = `${teamNameToAssign} drafted ${playerName} (${position}, ${nhlTeam}) (Pick ${currentPickNumber})`;
                }
                addChatMessage({ type: 'system', text: chatMessageText, timestamp: serverTimestamp() });

                // Advance to the next drafter (Firebase function handles logic)
                moveToNextDrafter();

            }).catch((error) => {
                console.error(`Error drafting player ${playerName}:`, error);
                showNotification(`Error drafting player: ${error.message}`, 7000);
                filterPlayers(); // Re-enable buttons on error
            });
        }

        function disableAllDraftButtons() {
            playerTableBody.querySelectorAll('.draft-button').forEach(btn => {
                if (!btn.disabled) {
                    btn.disabled = true;
                    // Optionally change text: btn.textContent = 'Processing...';
                }
            });
        }

         // Remove a player from the drafted list (Commissioner only)
         function removeDraftedPlayer(firebaseKey, playerNameForMessage) {
             if (!isCommissioner) {
                 showNotification("Only the commissioner can remove drafted players.");
                 return;
             }
             if (!firebaseKey) {
                 console.error("Cannot remove player: Firebase key is missing.");
                 showNotification("Error: Cannot remove player without key.");
                 return;
             }

             const name = playerNameForMessage || 'this player';
             if (!confirm(`Are you sure you want to UNDO the draft pick for ${name}? This cannot be easily reversed.`)) {
                 return;
             }

             console.log(`Commissioner removing player with key: ${firebaseKey}`);
             const playerRef = ref(database, `leagues/${leagueId}/draftedPlayers/${firebaseKey}`);

             set(playerRef, null).then(() => {
                 console.log(`Player ${name} removed successfully.`);
                 showNotification(`${name} removed from draft.`);
                 addChatMessage({
                     type: 'system',
                     text: `${currentUser.displayName} (Commish) removed ${name} from the draft list.`,
                     timestamp: serverTimestamp()
                 });
                 // Data updates via onValue listener
             }).catch(error => {
                 console.error(`Error removing player (Key: ${firebaseKey}):`, error);
                 showNotification(`Error removing player: ${error.message}`, 7000);
             });
         }


        // Filter and display the DRAFTED players list
        function filterDraftedPlayers() {
            if (!draftedTableBody) return;
            const teamFilter = draftedTeamFilter.value; // Filter by team name
            draftedTableBody.innerHTML = '';

            // Use the globally sorted and numbered draftedPlayers array
            let filtered = draftedPlayers;
            if (teamFilter !== 'all') {
                filtered = filtered.filter(player => player.Team === teamFilter);
            }

            const fragment = document.createDocumentFragment();

            if (filtered.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center;">${teamFilter === 'all' ? 'No players drafted yet.' : 'No players drafted for this team yet.'}</td>`;
                fragment.appendChild(row);
            } else {
                filtered.forEach((player) => {
                    const row = document.createElement('tr');
                    const canRemove = isCommissioner; // Only commissioner can remove
                    // Sanitize name for the remove button function call
                    const safePlayerName = (player.Player || 'N/A').replace(/\'/g, "\\'").replace(/"/g, '&quot;');

                    row.innerHTML = `
                        <td style="width: 5%; text-align: center;">${player.draftNumber || '-'}</td>
                        <td>${player.Player || 'N/A'}</td>
                        <td>${player.Position || 'N/A'}</td>
                        <td class="hide-mobile">${player["NHL Team"] || 'N/A'}</td>
                        <td>${player.Team || 'N/A'}</td>
                        <td>
                            ${canRemove ? `<button class="remove-button btn danger" onclick="removeDraftedPlayer('${player.firebaseKey}', '${safePlayerName}')">Remove</button>` : ''}
                        </td>
                    `;
                    fragment.appendChild(row);
                });
            }
            draftedTableBody.appendChild(fragment);
        }


        // --- Draft Control (Start, Advance) ---
        function startDraft() {
            if (!isCommissioner) {
                showNotification("Only the commissioner can start the draft."); return;
            }
            const teamUids = Object.keys(currentTeams || {});
            if (teamUids.length < 2) { // Require at least 2 teams
                showNotification("Need at least 2 teams to start a draft."); return;
            }
            if (!confirm(`Start the draft for "${leagueData?.name ?? 'this league'}"? Draft order will be randomized.`)) {
                return;
            }
            console.log("Commissioner starting draft...");

            // Randomize draft order (Fisher-Yates shuffle)
            let draftOrder = [...teamUids];
            for (let i = draftOrder.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [draftOrder[i], draftOrder[j]] = [draftOrder[j], draftOrder[i]];
            }
            console.log("Randomized draft order:", draftOrder);

            const initialDraftStatus = {
                active: true,
                startedAt: serverTimestamp(),
                startedByUid: currentUser.uid,
                draftOrder: draftOrder,
                currentDrafter: draftOrder[0], // First pick
                round: 1,
                pickNumber: 1, // Overall pick number
                // Add other settings like 'snakeDraft: false' if needed later
            };

            // --- Write to Firebase ---
             // Consider clearing previous draft picks here if desired
             // const draftedPlayersRef = ref(database, `leagues/${leagueId}/draftedPlayers`);
             // set(draftedPlayersRef, null).then(...)

            const draftStatusRef = ref(database, `leagues/${leagueId}/draftStatus`);
            set(draftStatusRef, initialDraftStatus).then(() => {
                console.log("Draft status set, draft started.");
                const firstDrafterName = currentTeams[draftOrder[0]]?.name ?? 'First Pick';
                const startMessage = `Draft started by ${currentUser.displayName}! Draft order randomized. ${firstDrafterName} is up first.`;
                addChatMessage({ type: 'system', text: startMessage, timestamp: serverTimestamp() });
                showNotification("Draft started!");
                // UI updates handled by onValue listener
            }).catch((error) => {
                console.error("Error starting draft:", error);
                showNotification(`Error starting draft: ${error.message}`, 7000);
            });
        }

        function moveToNextDrafter() {
            // Guard clauses
            if (!leagueData?.draftStatus?.draftOrder || !leagueData.draftStatus.currentDrafter) {
                console.error("Cannot move to next drafter: Missing draft status data.");
                showNotification("Error: Could not determine next drafter.", 7000);
                return;
            }

            const { draftOrder, currentDrafter, round, pickNumber } = leagueData.draftStatus;
            const currentIndex = draftOrder.indexOf(currentDrafter);
            const numTeams = draftOrder.length;

            if (currentIndex === -1) {
                console.error("Critical Error: Current drafter not found in order!");
                showNotification("Error: Draft order corrupted. Draft paused.", 10000);
                // Consider pausing: update(ref(database, `leagues/${leagueId}/draftStatus`), { active: false });
                return;
            }

             // Calculate next index, round, and pick number (Linear Draft)
             let nextIndex = currentIndex + 1;
             let nextRound = round;
             let nextPickNumber = (pickNumber || 0) + 1; // Increment overall pick

             if (nextIndex >= numTeams) {
                 nextIndex = 0; // Wrap around
                 nextRound++;
                 console.log(`Wrapping draft order, starting round ${nextRound}`);
             }

             // --- Snake Draft Logic Placeholder (Keep commented) ---
             // if (leagueData.draftSettings?.snakeDraft) { ... update nextIndex based on round ... }
             // ---

            const nextDrafterUid = draftOrder[nextIndex];
            console.log(`Next pick: ${nextDrafterUid}, Round: ${nextRound}, Pick#: ${nextPickNumber}`);

            // Update Firebase
            const draftStatusRef = ref(database, `leagues/${leagueId}/draftStatus`);
            update(draftStatusRef, {
                currentDrafter: nextDrafterUid,
                round: nextRound,
                pickNumber: nextPickNumber
            }).then(() => {
                console.log("Draft status updated for next turn.");
                // Announce in chat (handled by onValue listener reacting to change, avoid double messages)
                 const nextDrafterName = currentTeams[nextDrafterUid]?.name ?? 'Next Drafter';
                 // Add slight delay? Or just rely on listener? Rely on listener for now.
                 // addChatMessage({ type: 'system', text: `It's now ${nextDrafterName}'s turn (Pick ${nextPickNumber})` });

                 // Show notification if it's my turn now
                 if (nextDrafterUid === currentUser?.uid) {
                     showNotification("It's your turn to draft!", 7000);
                 }
            }).catch((error) => {
                console.error("Error updating draft status for next turn:", error);
                showNotification(`Error advancing draft turn: ${error.message}`, 7000);
                filterPlayers(); // Try re-enabling buttons if failed
            });
        }

        // --- Event Listeners for Filters & Sorting ---
        document.querySelectorAll('.position-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPositionFilter = btn.dataset.position;
                filterPlayers(); // Re-filter available players
            });
        });

        document.querySelectorAll('th[data-sort]').forEach(header => {
            header.addEventListener('click', () => {
                const columnKey = header.dataset.sort;
                const table = header.closest('table');
                if (!table || !columnKey) return;

                const isPlayerTable = table.id === 'playerTable';
                let sortDirection;

                if (header.classList.contains('sorted-asc')) {
                    sortDirection = 'desc';
                } else {
                    sortDirection = 'asc'; // Default asc
                }

                // Update classes on clicked header
                table.querySelectorAll('th[data-sort]').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                header.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                console.log(`Sorting table '${table.id}' by '${columnKey}' ${sortDirection}`);

                if (isPlayerTable) {
                    currentSortColumn = columnKey;
                    currentSortDirection = sortDirection;
                    filterPlayers(); // filterPlayers applies sorting
                } else {
                    sortAndRenderDraftedTable(columnKey, sortDirection); // Sort local drafted array
                }
            });
        });

        function sortAndRenderDraftedTable(columnKey, direction) {
            // Sort the global draftedPlayers array based on the column key and direction
             draftedPlayers.sort((a, b) => {
                 let aValue = a[columnKey];
                 let bValue = b[columnKey];
                 const defaultStr = '';
                 // Sort 'Pick#' (draftNumber) numerically, others potentially alphabetically
                 const isNumericSort = columnKey === 'draftNumber';
                 const defaultNum = direction === 'asc' ? Infinity : -Infinity; // Sort nulls appropriately

                 if (isNumericSort) {
                     aValue = Number(aValue ?? defaultNum);
                     bValue = Number(bValue ?? defaultNum);
                     return direction === 'asc' ? aValue - bValue : bValue - aValue;
                 } else { // Assume string sort for others
                     aValue = (aValue ?? defaultStr).toString().toLowerCase();
                     bValue = (bValue ?? defaultStr).toString().toLowerCase();
                     return direction === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                 }
             });
             // Re-render the drafted table using the now-sorted global array
             filterDraftedPlayers();
         }

        // --- Chat Functionality ---
        function setupChat() {
            if (!chatContainer || !chatHeader || !chatToggle || !chatSend || !chatInput) return;
            chatHeader.addEventListener('click', (e) => { if (e.target !== chatToggle) toggleChatWindow(); });
            chatToggle.addEventListener('click', toggleChatWindow);
            chatSend.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); } });
        }

        function toggleChatWindow() {
            const isMinimized = chatContainer.classList.toggle('minimized');
            chatToggle.textContent = isMinimized ? '+' : '−'; // Use minus sign
            if (!isMinimized) scrollToChatBottom(true); // Scroll on open
        }

        function sendChatMessage() {
            const messageText = chatInput.value.trim();
            if (!messageText || !currentUser || !leagueId) return;

            addChatMessage({
                type: 'user',
                uid: currentUser.uid,
                name: currentTeams[currentUser.uid]?.name || currentUser.displayName || 'User', // Prefer team name
                photoURL: currentTeams[currentUser.uid]?.photoURL || currentUser.photoURL || null, // Prefer team photo
                text: messageText,
                timestamp: serverTimestamp()
            });
            chatInput.value = '';
            // chatInput.focus(); // Maybe annoying on mobile
        }

        function addChatMessage(messageObject) {
            if (!leagueId) return;
            const chatRef = ref(database, `leagues/${leagueId}/chat`);
            push(chatRef, messageObject).catch(error => {
                console.error("Error sending chat message:", error);
                showNotification(`Error sending message: ${error.message}`, 7000);
            });
        }

        function updateChatMessages(messagesObject) {
            if (!chatMessages) return;
            const shouldScroll = chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + 50;
            chatMessages.innerHTML = ''; // Clear and rebuild (simpler for limited history)
            const fragment = document.createDocumentFragment();

            const sortedKeys = Object.keys(messagesObject).sort((keyA, keyB) =>
                (messagesObject[keyA]?.timestamp ?? 0) - (messagesObject[keyB]?.timestamp ?? 0)
            );

            sortedKeys.forEach(key => {
                const message = messagesObject[key];
                if (!message || !message.text) return; // Skip empty

                const messageEl = document.createElement('div');
                const sanitize = (str) => (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                if (message.type === 'system') {
                    messageEl.className = 'chat-system';
                    messageEl.textContent = sanitize(message.text);
                } else {
                    messageEl.className = 'chat-message';
                    // Format timestamp (locale-specific)
                    const timeStr = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : '';

                    const safeName = sanitize(message.name || 'User');
                    const safeText = sanitize(message.text);
                    const avatarImg = message.photoURL
                        ? `<img src="${sanitize(message.photoURL)}" alt="" class="user-avatar">`
                        : `<span class="user-avatar" style="background-color: ${getUserColor(message.uid)};"></span>`; // Placeholder with color hash

                    messageEl.innerHTML = `
                        <div class="chat-user">
                            ${avatarImg}
                            <strong>${safeName}</strong>
                            <span class="chat-time">${timeStr}</span>
                        </div>
                        <div class="chat-text">${safeText.replace(/\n/g, '<br>')}</div> <!-- Allow line breaks -->
                    `;
                }
                fragment.appendChild(messageEl);
            });
            chatMessages.appendChild(fragment);
            if (shouldScroll) scrollToChatBottom(true); // Force scroll if was at bottom
        }

        // Simple hash function for placeholder color
        function getUserColor(uid) {
            let hash = 0;
            for (let i = 0; i < (uid?.length || 0); i++) {
                hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return "#" + "00000".substring(0, 6 - c.length) + c;
        }

        function scrollToChatBottom(force = false) {
            if (!chatMessages) return;
            const scrollTolerance = 50;
            if (force || chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + scrollTolerance) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // --- Helper Functions ---
        function setupAuthPersistence() {
            // Handled by Firebase SDK setting: browserSessionPersistence
        }

        function handleNoAccessToLeague(leagueDataToShow) {
            resetUIState();
            leagueSelectContainer.classList.remove('hidden'); // Show selection area

            const leagueName = leagueDataToShow?.name ?? 'this league';
            const teams = leagueDataToShow?.teams || {};
            const teamUids = Object.keys(teams);
            const currentUid = currentUser?.uid || 'unknown';

            console.warn(`Access denied. User UID: ${currentUid}`);
            console.warn(`League Teams:`, teamUids);

            if (leagueListEl) {
                leagueListEl.innerHTML = `
                    <div class="card" style="border-color: #dc3545;">
                        <h2>Access Denied</h2>
                        <p>You are not a member of "${leagueName}".</p>
                        <p>Your account (${currentUser?.email}) is not listed under the league's teams.</p>
                        <p>If this is unexpected, ensure you're signed in with the correct Google account or rejoin from the Manage Leagues page.</p>
                        <a href="manage-leagues.html" class="btn secondary">Go to Manage Leagues</a>
                    </div>`;
            }

            cleanupListeners();
            leagueId = null;
        }


        function showNotification(message, duration = 5000) {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            console.log(`Notify: ${message}`);

            setTimeout(() => {
                notification.style.opacity = '0';
                 setTimeout(() => notification.remove(), 500); // Remove after fade
            }, duration - 500);
        }

        function cleanupListeners() {
            console.log("Cleaning up Firebase listeners...");
            let cleanedCount = 0;
             const cleanup = (listenersObj, type) => {
                 Object.entries(listenersObj).forEach(([key, unsubscribe]) => {
                     if (typeof unsubscribe === 'function') {
                         try { unsubscribe(); console.log(` - Unsubscribed from ${type}: ${key}`); cleanedCount++; }
                         catch (e) { console.error(`Error unsubscribing ${type} ${key}:`, e); }
                     }
                 });
                 return {}; // Return empty object
             };
            playerListeners = cleanup(playerListeners, 'player listener');
            chatListeners = cleanup(chatListeners, 'chat listener');

            // Clean up draft status listener
            if (draftStatusListener && leagueId) {
                 try {
                     const draftStatusRef = ref(database, `leagues/${leagueId}/draftStatus`);
                     off(draftStatusRef, 'value', draftStatusListener); // Correct Firebase V9 way
                     console.log(" - Unsubscribed from draft status listener.");
                     cleanedCount++;
                 } catch (e) { console.error("Error unsubscribing draft status listener:", e); }
                 draftStatusListener = null;
             }

            // Clean up presence listener (handled by Firebase on disconnect)
            window.removeEventListener('beforeunload', handlePageLeave);
            console.log(`Cleanup complete. ${cleanedCount} listeners removed.`);
        }

        // --- Global Access & DOM Ready ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Ready.");
            setupChat();
            // Initial state check (wait for auth)
            if (leagueId && !currentUser) console.log("League ID found, waiting for auth...");
        });

        // Make functions globally accessible for inline HTML calls
        window.draftPlayer = draftPlayer;
        window.removeDraftedPlayer = removeDraftedPlayer;
        window.filterPlayers = filterPlayers;
        window.filterDraftedPlayers = filterDraftedPlayers;

    </script>
</body>
</html>
