<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Hockey League Manager</title>
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #0055a4;
            --accent-color: #ffd700;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --light-text: #f8f9fa;
            --border-color: #dee2e6;
            --hover-bg: #e9ecef;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: var(--dark-text);
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            flex-grow: 1;
        }
        
        h1, h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .container {
            background-color: #fff;
            border-radius: 0.25rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            main {
                padding: 15px;
            }
            .container {
                padding: 1rem;
            }
            .tab button {
                padding: 8px 12px;
                font-size: 14px;
            }
            .league-action {
                flex-direction: column;
                align-items: flex-start;
            }
            .league-action button {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .tab {
                display: flex;
                flex-direction: column;
            }
            .tab button {
                width: 100%;
                border-radius: 0;
                border-bottom: 1px solid #ccc;
            }
            .tab button:last-child {
                border-bottom: none;
            }
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        button {
            background-color: var(--primary-color);
            color: var(--light-text);
            border: 1px solid var(--primary-color);
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
        }
        button:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        button:disabled {
            background-color: #cccccc;
            border-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .managers-list {
            margin-top: 15px;
        }
        .manager-item {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remove-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .auth-container {
            background-color: #fff;
            padding: 1rem 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        #auth-status {
            margin: 0.5rem 0 0 0;
            font-style: italic;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .hidden {
            display: none;
        }
        .error {
            color: #ff0000;
            margin-top: 5px;
        }
        .success {
            color: #008000;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
        }
        .loading:after {
            content: ".";
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80%, 100% { content: ""; }
        }
        .leagues-list {
            margin-top: 30px;
        }
        .league-item {
            background-color: #f0f0f0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .league-item:hover {
            background-color: #e0e0e0;
        }
        .league-name {
            font-weight: bold;
            font-size: 18px;
        }
        .league-details {
            color: #666;
            margin-top: 5px;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            margin-bottom: 20px;
        }
        .tab button {
            background-color: #f1f1f1;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            animation: fadeEffect 1s;
        }
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        .league-section {
            margin-bottom: 30px;
        }
        .league-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-active {
            background-color: #4CAF50;
            color: white;
        }
        .status-pending {
            background-color: #FFC107;
            color: black;
        }
        .status-invitation {
            background-color: #2196F3;
            color: white;
        }
        .league-action {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .league-action button {
            padding: 8px 12px;
            font-size: 14px;
        }
        .share-box {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f7fe;
            border: 1px solid #b3e5fc;
            border-radius: 4px;
        }
        .share-link {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .copy-btn {
            background-color: #4CAF50;
            margin-right: 10px;
        }
        #password-confirm-group {
            margin-top: 10px;
        }
        .password-toggle {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 10px;
            cursor: pointer;
            color: #666;
            font-size: 14px;
        }
        .badge {
            display: inline-block;
            padding: 2px 5px;
            font-size: 11px;
            border-radius: 3px;
            margin-left: 5px;
            vertical-align: middle;
        }
        .commissioner-badge {
            background-color: #FFD700;
            color: #333;
        }
        .join-password-group {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #333;
            color: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideInOut 5s ease-in-out forwards;
        }
        @keyframes slideInOut {
            0% { transform: translateX(100%); opacity: 0; }
            10% { transform: translateX(0); opacity: 1; }
            90% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        .nav-links {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
        }
        .nav-links a {
            color: #003366;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            border: 1px solid #003366;
            transition: all 0.3s;
        }
        .nav-links a:hover {
            background-color: #003366;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Fantasy Hockey League Manager</h1>
    
    <div class="auth-container">
        <button id="login-btn">Sign in with Google</button>
        <button id="logout-btn" class="hidden">Sign Out</button>
        <div id="auth-status">You are not signed in</div>
    </div>
    
    <div id="content-container" class="hidden">
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'my-leagues')">My Leagues</button>
            <button class="tablinks" onclick="openTab(event, 'create-league')">Create League</button>
            <button class="tablinks" onclick="openTab(event, 'join-league')">Join League</button>
        </div>
        
        <div id="my-leagues" class="tabcontent" style="display:block;">
            <h2>My Leagues</h2>
            
            <div class="league-section">
                <h3>Active Leagues</h3>
                <div id="active-leagues" class="leagues-list">
                    <div class="loading">Loading your leagues</div>
                </div>
            </div>
            
            <div class="league-section">
                <h3>League Invitations</h3>
                <div id="league-invitations" class="leagues-list">
                    <div class="loading">Loading invitations</div>
                </div>
            </div>
        </div>
        
        <div id="join-league" class="tabcontent">
            <h2>Join a League</h2>
            <p>Enter a league code to join:</p>
            
            <div class="form-group">
                <label for="league-code">League Code:</label>
                <div style="display: flex;">
                    <input type="text" id="league-code" placeholder="Enter league code">
                    <button style="width: 100px; margin-left: 10px;" onclick="findLeagueByCode()">Find</button>
                </div>
            </div>
                        
            <div id="join-status"></div>
        </div>
        
        <div id="create-league" class="tabcontent">
            <h2>Create a New League</h2>
            <form id="create-league-form">
                <div class="form-group">
                    <label for="league-name">League Name:</label>
                    <input type="text" id="league-name" placeholder="Enter league name" required>
                </div>
                
                <div class="form-group">
                    <label for="max-teams">Number of Teams:</label>
                    <select id="max-teams">
                        <option value="4">4 Teams</option>
                        <option value="6">6 Teams</option>
                        <option value="8" selected>8 Teams</option>
                        <option value="10">10 Teams</option>
                        <option value="12">12 Teams</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="league-password">League Password:</label>
                    <div class="password-toggle">
                        <input type="password" id="league-password" placeholder="Create a password for others to join" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('league-password')">Show</span>
                    </div>
                    <p class="password-hint">This password will be required for users to join unless they're invited by email.</p>
                </div>
                
                <div id="password-confirm-group" class="form-group">
                    <label for="confirm-password">Confirm Password:</label>
                    <div class="password-toggle">
                        <input type="password" id="confirm-password" placeholder="Confirm the password" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('confirm-password')">Show</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">League Description (optional):</label>
                    <textarea id="description" rows="3" placeholder="Describe your league..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Invite Managers (optional):</label>
                    <div style="display: flex;">
                        <input type="email" id="manager-email" placeholder="Enter email address">
                        <button type="button" style="width: 100px; margin-left: 10px;" onclick="addManager()">Add</button>
                    </div>
                    
                    <div id="managers-list" class="managers-list">
                        <!-- Manager items will be added here -->
                    </div>
                </div>
                
                <div id="create-status"></div>
                
                <button type="submit">Create League</button>
            </form>
        </div>
    </div>
    
    <div class="nav-links">
        <a href="index.html">Standings</a>
        <a href="https://github.com/your-username/fantasy-hockey-app" target="_blank">GitHub</a>
    </div>
    
    <!-- Before initializing Firebase, add this script tag -->
    <script src="firebaseConfig.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase configuration will be injected by GitHub Actions
        const firebaseConfig = {
            apiKey: "PLACEHOLDER",
            authDomain: "playofffantasyhockey.firebaseapp.com",
            databaseURL: "https://playofffantasyhockey-default-rtdb.firebaseio.com",
            projectId: "playofffantasyhockey",
            storageBucket: "playofffantasyhockey.appspot.com",
            messagingSenderId: "PLACEHOLDER",
            appId: "PLACEHOLDER"
        };

        // Initialize Firebase with config
        const app = initializeApp(window.firebaseConfig || {
            apiKey: "PLACEHOLDER",
            authDomain: "playofffantasyhockey.firebaseapp.com",
            databaseURL: "https://playofffantasyhockey-default-rtdb.firebaseio.com",
            projectId: "playofffantasyhockey",
            storageBucket: "playofffantasyhockey.appspot.com",
            messagingSenderId: "PLACEHOLDER",
            appId: "PLACEHOLDER"
        });
        const auth = getAuth();
        const provider = new GoogleAuthProvider();
        const database = getDatabase();
        let currentUser = null;
        let invitedManagers = [];
        let foundLeague = null;
        
        // Check for URL parameters (for direct join links)
        const urlParams = new URLSearchParams(window.location.search);
        let actionFromUrl = null;
        let leagueIdFromUrl = null;
        let leagueCodeFromUrl = null;
        
        if (urlParams.has('action') && urlParams.has('league')) {
            actionFromUrl = urlParams.get('action');
            leagueIdFromUrl = urlParams.get('league');
            if (urlParams.has('code')) {
                leagueCodeFromUrl = urlParams.get('code');
            }
        }
        
        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('auth-status').textContent = `Signed in as ${user.displayName}`;
                document.getElementById('content-container').classList.remove('hidden');
                
                // Initialize Gmail API if needed
                initGmailAPI();
                
                // Load user's leagues
                loadUserLeagues();
                
                // Check for direct actions from URL
                handleUrlActions();
            } else {
                // User is signed out
                currentUser = null;
                document.getElementById('login-btn').classList.remove('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                document.getElementById('auth-status').textContent = 'You are not signed in';
                document.getElementById('content-container').classList.add('hidden');
            }
        });
        
        // Sign in with Google
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    // User signed in
                    console.log("User signed in:", result.user);
                }).catch((error) => {
                    // Handle errors
                    console.error("Auth error:", error);
                    document.getElementById('auth-status').textContent = `Error: ${error.message}`;
                });
        });
        
        // Sign out
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("User signed out");
            }).catch((error) => {
                console.error("Sign out error:", error);
            });
        });
        
        // Handle actions from URL params
        function handleUrlActions() {
            if (!actionFromUrl || !leagueIdFromUrl || !currentUser) return;
            
            if (actionFromUrl === 'join') {
                // If we have a direct join link with league ID and code
                findLeagueById(leagueIdFromUrl).then(league => {
                    if (league) {
                        foundLeague = {
                            id: leagueIdFromUrl,
                            ...league
                        };
                        
                        // If user is already in this league, just go to tab
                        if (league.teams && league.teams[currentUser.uid]) {
                            showNotification("You're already a member of this league");
                            openTab(null, 'my-leagues');
                            return;
                        }
                        
                        // Switch to join tab and show league details
                        openTab(null, 'join-league');
                        
                        const leagueNameEl = document.getElementById('found-league-name');
                        const leagueInfoEl = document.getElementById('found-league-info');
                        const leagueDetailsEl = document.getElementById('league-details');
                        const passwordGroupEl = document.getElementById('join-password-required');
                        const joinButton = document.getElementById('join-league-btn');
                        
                        leagueNameEl.textContent = league.name;
                        leagueInfoEl.textContent = `Teams: ${Object.keys(league.teams || {}).length}/${league.maxTeams}`;
                        leagueDetailsEl.classList.remove('hidden');
                        
                        // Check if user is invited (doesn't need password)
                        const isInvited = (league.invitedManagers || []).some(m => 
                            m.email === currentUser.email
                        );
                        
                        // If we have a code from URL and it matches, or user is invited, no password needed
                        if ((leagueCodeFromUrl && leagueCodeFromUrl === league.code) || isInvited) {
                            passwordGroupEl.classList.add('hidden');
                        } else {
                            passwordGroupEl.classList.remove('hidden');
                        }
                        
                        // Store data directly on the button
                        joinButton.dataset.leagueId = leagueIdFromUrl;
                        joinButton.dataset.leagueName = league.name;
                        joinButton.dataset.leagueCode = league.code;
                        joinButton.dataset.passwordRequired = !isInvited;
                        joinButton.dataset.passwordValue = league.password;
                        joinButton.dataset.isInvited = isInvited;
                    } else {
                        showNotification("League not found");
                    }
                }).catch(error => {
                    console.error("Error finding league:", error);
                    showNotification("Error finding league");
                });
            }
            
            // Clear URL params after handling
            window.history.replaceState({}, document.title, window.location.pathname);
            actionFromUrl = null;
            leagueIdFromUrl = null;
            leagueCodeFromUrl = null;
        }
        
        // Create league form submission
        document.getElementById('create-league-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                showNotification("You must be signed in to create a league");
                return;
            }
            
            const leagueName = document.getElementById('league-name').value.trim();
            const maxTeams = parseInt(document.getElementById('max-teams').value);
            const description = document.getElementById('description').value.trim();
            const password = document.getElementById('league-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();
            
            if (!leagueName) {
                document.getElementById('create-status').innerHTML = '<div class="error">Please enter a league name</div>';
                return;
            }
            
            if (!password) {
                document.getElementById('create-status').innerHTML = '<div class="error">Please enter a league password</div>';
                return;
            }
            
            if (password !== confirmPassword) {
                document.getElementById('create-status').innerHTML = '<div class="error">Passwords do not match</div>';
                return;
            }
            
            // Generate a unique code for the league
            const leagueCode = generateLeagueCode();
            
            // Create the league object
            const leagueData = {
                name: leagueName,
                code: leagueCode,
                password: password,
                description: description,
                maxTeams: maxTeams,
                createdBy: {
                    uid: currentUser.uid,
                    name: currentUser.displayName,
                    email: currentUser.email
                },
                createdAt: new Date().toISOString(),
                teams: {}, // Ensure teams always exists
                invitedManagers: invitedManagers,
                settings: {
                    status: 'active', // active, completed, etc.
                    draftStatus: 'pending' // pending, scheduled, completed
                }
            };

            // Set the team structure explicitly after
            leagueData.teams[currentUser.uid] = {
                name: currentUser.displayName,
                uid: currentUser.uid,
                email: currentUser.email,
                isCommissioner: true,
                joinedAt: new Date().toISOString()
            };
            
            // Save to Firebase
            const leaguesRef = ref(database, 'leagues');
            const newLeagueRef = push(leaguesRef);
            
            // Store the initial system message text
            const initialChatMessageText = `League "${leagueName}" created by ${currentUser.displayName}`;

            // Remove chat from initial league data
            delete leagueData.chat;

            set(newLeagueRef, leagueData)
                .then(() => {
                    // Add the initial chat message using the standard function
                    return addChatMessage(newLeagueRef.key, {
                        type: 'system',
                        text: initialChatMessageText,
                        timestamp: leagueData.createdAt // Use the league creation timestamp
                    });
                })
                .then(() => {
                    // Link league to user
                    const userLeaguesRef = ref(database, `users/${currentUser.uid}/leagues/${newLeagueRef.key}`);
                    return set(userLeaguesRef, {
                        leagueId: newLeagueRef.key,
                        name: leagueName,
                        code: leagueCode,
                        role: 'commissioner',
                        joinedAt: new Date().toISOString()
                    });
                })
                .then(() => {
                    // Show success message with sharing options
                    const joinLink = `${window.location.origin}/Fantasy_Hockey/manage-leagues.html?action=join&league=${newLeagueRef.key}&code=${leagueCode}`;
                    
                    document.getElementById('create-status').innerHTML = `
                        <div class="success">
                            League created successfully!
                        </div>
                        <div class="share-box">
                            <p><strong>Share with others:</strong></p>
                            <p>League Code: <strong>${leagueCode}</strong></p>
                            <input type="text" class="share-link" value="${joinLink}" readonly>
                            <div>
                                <button type="button" class="copy-btn" onclick="copyToClipboard('${joinLink}')">Copy Link</button>
                                <a href="draftcentre.html?league=${newLeagueRef.key}" class="back-to-standings">Go to Draftcentre</a>
                            </div>
                        </div>
                    `;
                    
                    // Send email invitations before resetting the invitedManagers array
                    if (invitedManagers.length > 0) {
                        sendEmailInvitations(newLeagueRef.key, leagueName, leagueCode, invitedManagers);
                    }
                    
                    // Now reset the form and invitedManagers list
                    document.getElementById('create-league-form').reset();
                    invitedManagers = [];
                    document.getElementById('managers-list').innerHTML = '';
                    
                    // Refresh user leagues
                    loadUserLeagues();
                })
                .catch((error) => {
                    console.error("Error creating league:", error);
                    document.getElementById('create-status').innerHTML = `<div class="error">Error creating league: ${error.message}</div>`;
                });
        });
        
        // Modified findLeagueByCode function to use the new joinFoundLeague function
        window.findLeagueByCode = function() {
            if (!currentUser) {
                showNotification("You must be signed in to join a league");
                return;
            }

            const leagueCode = document.getElementById('league-code').value.trim();
            if (!leagueCode) {
                showNotification("Please enter a league code");
                return;
            }

            const leaguesRef = ref(database, 'leagues');
            get(leaguesRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    throw new Error("No leagues found");
                }

                const leagues = snapshot.val();
                let foundLeagueId = null;

                Object.keys(leagues).forEach(leagueId => {
                    if (leagues[leagueId].code === leagueCode) {
                        foundLeagueId = leagueId;
                        foundLeague = {
                            id: leagueId,
                            ...leagues[leagueId]
                        };
                    }
                });

                if (!foundLeagueId) {
                    throw new Error("League not found with this code");
                }

                const league = foundLeague;

                // Check if already a member
                if (league.teams && league.teams[currentUser.uid]) {
                    showNotification("You're already a member of this league");
                    window.location.href = `draftcentre.html?league=${foundLeagueId}`;
                    return;
                }

                // Check if league is full
                const teamCount = Object.keys(league.teams || {}).length;
                if (teamCount >= league.maxTeams) {
                    throw new Error("This league is full");
                }

                // Render the league info
                const invitationsEl = document.getElementById('league-invitations');
                invitationsEl.innerHTML = '';

                const leagueItem = document.createElement('div');
                leagueItem.className = 'league-item';
                leagueItem.innerHTML = `
                    <div class="league-name">
                        ${league.name}
                        <span class="league-status status-invitation">League Found</span>
                    </div>
                    <div class="league-details">
                        Teams: ${teamCount}/${league.maxTeams}
                        <br>From: ${league.createdBy?.name || 'Unknown'}
                        ${league.description ? `<br>${league.description}` : ''}
                    </div>
                    <div class="league-action">
                        <button onclick="joinFoundLeague('${foundLeagueId}')">Join</button>
                        <button onclick="clearJoinSearch()" class="remove-btn">Cancel</button>
                    </div>
                `;

                invitationsEl.appendChild(leagueItem);
                openTab(null, 'my-leagues');
            }).catch(error => {
                console.error("Error finding league:", error);
                document.getElementById('join-status').innerHTML = `<div class="error">${error.message}</div>`;
            });
        };

        
        // Join the found league
        window.joinFoundLeague = function(leagueId) {
            if (!currentUser) {
                showNotification("You must be signed in to join a league");
                return;
            }
            
            // Find the league first to get fresh data
            findLeagueById(leagueId).then(league => {
                if (!league) {
                    throw new Error("League not found");
                }
                
                // Check if already a member
                if (league.teams && league.teams[currentUser.uid]) {
                    showNotification("You're already a member of this league");
                    return;
                }
                
                // Check if league is full
                const teamCount = Object.keys(league.teams || {}).length;
                if (teamCount >= league.maxTeams) {
                    throw new Error("This league is full");
                }
                
                // Check if user is invited (doesn't need password)
                const isInvited = (league.invitedManagers || []).some(m => 
                    m.email === currentUser.email
                );
                
                if (!isInvited) {
                    // Not invited, so prompt for password
                    const passwordPrompt = prompt(`Please enter the password for league "${league.name}":`, "");
                    
                    if (passwordPrompt === null) {
                        // User cancelled the prompt
                        return;
                    }
                    
                    if (passwordPrompt.trim() !== league.password) {
                        showNotification("Incorrect password");
                        return;
                    }
                }
                
                // Password correct or user is invited, proceed with joining
                const teamRef = ref(database, `leagues/${leagueId}/teams/${currentUser.uid}`);
                
                set(teamRef, {
                    name: currentUser.displayName,
                    uid: currentUser.uid,
                    email: currentUser.email,
                    isCommissioner: false,
                    joinedAt: new Date().toISOString()
                }).then(() => {
                    // Add league to user's leagues
                    const userLeagueRef = ref(database, `users/${currentUser.uid}/leagues/${leagueId}`);
                    return set(userLeagueRef, {
                        leagueId: leagueId,
                        name: league.name,
                        code: league.code,
                        role: 'manager',
                        joinedAt: new Date().toISOString()
                    });
                }).then(() => {
                    // Remove from invited managers if they were invited
                    if (isInvited) {
                        return removeInvitation(leagueId, currentUser.email);
                    }
                    return Promise.resolve();
                }).then(() => {
                    // Add system message to chat
                    return addChatMessage(leagueId, {
                        type: 'system',
                        text: `${currentUser.displayName} joined the league`,
                        timestamp: new Date().toISOString()
                    });
                }).then(() => {
                    showNotification("You've joined the league successfully!");
                    window.location.href = `draftcentre.html?league=${leagueId}`;
                }).catch(error => {
                    console.error("Error joining league:", error);
                    showNotification(`Error: ${error.message}`);
                });
            }).catch(error => {
                console.error("Error finding league:", error);
                showNotification(`Error: ${error.message}`);
            });
        };
        
        // Accept invitation
        window.acceptInvitation = function(leagueId) {
            // Find the league
            findLeagueById(leagueId).then(league => {
                if (!league) {
                    throw new Error("League not found");
                }
                
                // Check if already a member
                if (league.teams && league.teams[currentUser.uid]) {
                    throw new Error("Already a member of this league");
                }
                
                // Check if invited
                const isInvited = (league.invitedManagers || []).some(m => 
                    m.email === currentUser.email
                );
                
                if (!isInvited) {
                    throw new Error("Not invited to this league");
                }
                
                // Make sure we're writing to the correct path
                const teamRef = ref(database, `leagues/${leagueId}/teams/${currentUser.uid}`);
                
                return set(teamRef, {
                    name: currentUser.displayName,
                    uid: currentUser.uid,
                    email: currentUser.email,
                    isCommissioner: false,
                    joinedAt: new Date().toISOString()
                }).then(() => {
                    // Add league to user's leagues
                    const userLeagueRef = ref(database, `users/${currentUser.uid}/leagues/${leagueId}`);
                    return set(userLeagueRef, {
                        leagueId: leagueId,
                        name: league.name,
                        code: league.code,
                        role: 'manager',
                        joinedAt: new Date().toISOString()
                    });
                }).then(() => {
                    // Remove from invited managers
                    removeInvitation(leagueId, currentUser.email);
                    
                    // Add system message to chat
                    addChatMessage(leagueId, {
                        type: 'system',
                        text: `${currentUser.displayName} joined the league`,
                        timestamp: new Date().toISOString()
                    });
                    
                    showNotification("You've joined the league successfully!");
                    loadUserLeagues();
                });
            }).catch(error => {
                console.error("Error accepting invitation:", error);
                showNotification(`Error: ${error.message}`);
            });
        };
        
        // Decline invitation
        window.declineInvitation = function(leagueId) {
            // Remove from invited managers
            removeInvitation(leagueId, currentUser.email).then(() => {
                showNotification("Invitation declined");
                loadUserLeagues();
            }).catch(error => {
                console.error("Error declining invitation:", error);
                showNotification(`Error: ${error.message}`);
            });
        };

        //clear join search
        window.clearJoinSearch = function () {
            foundLeague = null;
            document.getElementById('league-invitations').innerHTML = '<p>No pending invitations.</p>';
        };
        
        // Load user's leagues
        function loadUserLeagues() {
            if (!currentUser) return;
            
            const activeLeaguesEl = document.getElementById('active-leagues');
            const invitationsEl = document.getElementById('league-invitations');
            
            activeLeaguesEl.innerHTML = '<div class="loading">Loading your leagues</div>';
            invitationsEl.innerHTML = '<div class="loading">Loading invitations</div>';
            
            // First check user's leagues
            const userLeaguesRef = ref(database, `users/${currentUser.uid}/leagues`);
            
            get(userLeaguesRef).then((snapshot) => {
                const userLeagues = snapshot.exists() ? snapshot.val() : {};
                
                // Then check all leagues to find those with pending invitations
                const allLeaguesRef = ref(database, 'leagues');
                return get(allLeaguesRef).then((leaguesSnapshot) => {
                    const allLeagues = leaguesSnapshot.exists() ? leaguesSnapshot.val() : {};
                    return { userLeagues, allLeagues };
                });
            }).then(({ userLeagues, allLeagues }) => {
                let activeLeagues = [];
                let invitedLeagues = [];
                
                // Add user's active leagues
                Object.keys(userLeagues || {}).forEach(leagueId => {
                    if (allLeagues[leagueId]) {
                        activeLeagues.push({
                            id: leagueId,
                            ...allLeagues[leagueId],
                            userRole: userLeagues[leagueId].role,
                            status: 'active'
                        });
                    }
                });
                
                // Add leagues with pending invitations
                Object.keys(allLeagues || {}).forEach(leagueId => {
                    const league = allLeagues[leagueId];
                    
                    // Skip if user is already in this league
                    if (userLeagues && userLeagues[leagueId]) {
                        return;
                    }
                    
                    const invitedEmails = (league.invitedManagers || []).map(m => m.email);
                    
                    if (invitedEmails.includes(currentUser.email)) {
                        invitedLeagues.push({
                            id: leagueId,
                            ...league,
                            status: 'invited'
                        });
                    }
                });
                
                // Render the leagues
                renderActiveLeagues(activeLeagues);
                renderLeagueInvitations(invitedLeagues);
            }).catch(error => {
                console.error("Error loading leagues:", error);
                activeLeaguesEl.innerHTML = `<div class="error">Error loading leagues: ${error.message}</div>`;
                invitationsEl.innerHTML = '';
            });
        }
        
        // Render active leagues
        function renderActiveLeagues(leagues) {
            const leaguesContainer = document.getElementById('active-leagues');
            
            if (leagues.length === 0) {
                leaguesContainer.innerHTML = '<p>You haven\'t joined any leagues yet. Create a new league or join an existing one.</p>';
                return;
            }
            
            leaguesContainer.innerHTML = '';
            leagues.forEach(league => {
                const leagueItem = document.createElement('div');
                leagueItem.className = 'league-item';
                
                // Determine draft status
                let draftStatus = 'Waiting for draft';
                let draftStatusClass = 'status-pending';
                
                if (league.draftStatus && league.draftStatus.active) {
                    draftStatus = 'Draft in progress';
                    draftStatusClass = 'status-active';
                } else if (league.settings && league.settings.draftStatus === 'completed') {
                    draftStatus = 'Draft completed';
                    draftStatusClass = 'status-active';
                }
                
                // Check if user is commissioner
                const isCommissioner = league.teams && 
                                      league.teams[currentUser.uid] && 
                                      league.teams[currentUser.uid].isCommissioner;
                
                const commissionerBadge = isCommissioner ? 
                    '<span class="badge commissioner-badge">Commissioner</span>' : '';
                
                leagueItem.innerHTML = `
                    <div class="league-name">
                        ${league.name}
                        ${commissionerBadge}
                        <span class="league-status ${draftStatusClass}">${draftStatus}</span>
                    </div>
                    <div class="league-details">
                        Teams: ${Object.keys(league.teams || {}).length}/${league.maxTeams}
                        ${league.description ? `<br>${league.description}` : ''}
                    </div>
                    <div class="league-action">
                        <a href="draftcentre.html?league=${league.id}" class="back-to-standings">Go to Draftcentre</a>
                        <a href="league.html?id=${league.id}" class="back-to-standings">View League</a>
                        ${isCommissioner ? `<button onclick="manageLeague('${league.id}')">Manage</button>` : ''}
                    </div>
                `;
                
                leaguesContainer.appendChild(leagueItem);
            });
        }
        
        // Render league invitations
        function renderLeagueInvitations(leagues) {
            const leaguesContainer = document.getElementById('league-invitations');
            
            if (leagues.length === 0) {
                leaguesContainer.innerHTML = '<p>No pending invitations.</p>';
                return;
            }
            
            leaguesContainer.innerHTML = '';
            leagues.forEach(league => {
                const leagueItem = document.createElement('div');
                leagueItem.className = 'league-item';
                
                leagueItem.innerHTML = `
                    <div class="league-name">
                        ${league.name}
                        <span class="league-status status-invitation">Invitation</span>
                    </div>
                    <div class="league-details">
                        Teams: ${Object.keys(league.teams || {}).length}/${league.maxTeams}
                        <br>From: ${league.createdBy ? league.createdBy.name : 'Unknown'}
                        ${league.description ? `<br>${league.description}` : ''}
                    </div>
                    <div class="league-action">
                        <button onclick="acceptInvitation('${league.id}')">Accept</button>
                        <button onclick="declineInvitation('${league.id}')" class="remove-btn">Decline</button>
                    </div>
                `;
                
                leaguesContainer.appendChild(leagueItem);
            });
        }
        
        // Add chat message
        function addChatMessage(leagueId, message) {
            // Make sure we're using the correct path for chat messages
            const chatRef = ref(database, `leagues/${leagueId}/chat`);
            const newMessageRef = push(chatRef);
            return set(newMessageRef, message);
        }
        
        // Remove invitation
        function removeInvitation(leagueId, email) {
            return findLeagueById(leagueId).then(league => {
                if (!league || !league.invitedManagers) {
                    return;
                }
                
                // Find and remove the invitation
                const updatedInvites = league.invitedManagers.filter(m => 
                    m.email !== email
                );
                
                // Update the league
                const invitesRef = ref(database, `leagues/${leagueId}/invitedManagers`);
                return set(invitesRef, updatedInvites);
            });
        }
        
        // Find league by ID
        function findLeagueById(leagueId) {
            const leagueRef = ref(database, `leagues/${leagueId}`);
            return get(leagueRef).then(snapshot => {
                if (snapshot.exists()) {
                    const league = snapshot.val();
                    if (!league.teams) league.teams = {};
                    if (!league.settings) league.settings = {};
                    return league;
                }
                return null;
            });
        }
        
        // Initialize Gmail API
        function initGmailAPI() {
            console.log("Initializing Gmail API...");
            
            // Check if the gapi library exists
            if (!window.gapi) {
                console.error("Google API client not loaded");
                return;
            }
            
            // Load the API client library
            gapi.load('client', () => {
                console.log("GAPI client loaded, initializing...");
                
                gapi.client.init({
                    apiKey: window.gmailConfig?.apiKey || 'PLACEHOLDER',
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
                }).then(() => {
                    console.log('Gmail API initialized successfully');
                }).catch(error => {
                    console.error('Error initializing Gmail API', error);
                });
            });
        }
        
        // Send email invitations to invited managers
        function sendEmailInvitations(leagueId, leagueName, leagueCode, invitedManagers) {
            console.log("Sending email invitations to:", invitedManagers);
            
            if (!invitedManagers || invitedManagers.length === 0) {
                console.log("No managers to invite");
                return;
            }
            
            const joinLink = `${window.location.origin}/Fantasy_Hockey/manage-leagues.html`;
            
            // Send an email to each invited manager
            invitedManagers.forEach(manager => {
                const email = manager.email;
                
                // Create the email content
                const emailContent = `
                    <html>
                        <body>
                            <h2>You've been invited to join a Fantasy Hockey League!</h2>
                            <p>You've been invited by ${currentUser.displayName} to join the league "${leagueName}".</p>
                            <p>To join this league, simply click the link below:</p>
                            <p><a href="${joinLink}">Join "${leagueName}" League</a></p>
                            <p>Or you can join manually with this code: <strong>${leagueCode}</strong></p>
                            <p>Good luck!</p>
                        </body>
                    </html>
                `;
                
                // Use improved function to send email
                sendEmail(email, `Fantasy Hockey League Invitation: ${leagueName}`, emailContent);
            });
        }

        // Send an email using the Gmail API with Google Identity Services
        function sendEmail(to, subject, bodyHtml) {
            console.log("Starting email send process to:", to);
            
            // Show a notification to the user
            showNotification("Preparing to send invitation to " + to);
            
            // Check if the necessary libraries are loaded
            if (!window.gapi) {
                console.error("Google API client not loaded");
                showNotification("Error: Google API client not loaded");
                return;
            }
            
            if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
                console.error("Google Identity Services not initialized");
                showNotification("Error: Google Identity Services not initialized");
                return;
            }
            
            // Check if Gmail API is initialized
            if (!gapi.client.gmail) {
                console.log("Gmail API not initialized, initializing now...");
                
                gapi.client.init({
                    apiKey: window.gmailConfig?.apiKey || 'PLACEHOLDER',
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
                }).then(() => {
                    console.log("Gmail API initialized, continuing with authentication");
                    proceedWithAuthentication();
                }).catch(error => {
                    console.error("Error initializing Gmail API:", error);
                    showNotification("Error initializing Gmail API: " + error.message);
                });
            } else {
                proceedWithAuthentication();
            }
            
            function proceedWithAuthentication() {
                console.log("Creating token client...");
                
                // Create token client for OAuth with explicit error handling
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: window.gmailConfig?.clientId || 'PLACEHOLDER',
                    scope: 'https://www.googleapis.com/auth/gmail.send',
                    callback: (tokenResponse) => {
                        if (tokenResponse.error) {
                            console.error('Error getting token:', tokenResponse);
                            showNotification(`Authentication failed: ${tokenResponse.error}`);
                            return;
                        }
                        
                        console.log("Token received successfully");
                        
                        // Set access token for the client
                        gapi.client.setToken(tokenResponse);
                        
                        // Now send the actual email
                        sendEmailWithToken();
                    }
                });
                
                // Request an access token
                console.log("Requesting access token...");
                tokenClient.requestAccessToken();
            }
            
            function sendEmailWithToken() {
                console.log("Preparing email content...");
                
                try {
                    // Create the email content in base64url encoded format
                    const email = [
                        'Content-Type: text/html; charset="UTF-8"',
                        'MIME-Version: 1.0',
                        `To: ${to}`,
                        `Subject: ${subject}`,
                        '',
                        bodyHtml
                    ].join('\r\n');
                    
                    const encodedEmail = btoa(unescape(encodeURIComponent(email)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=+$/, '');
                    
                    console.log("Sending email request...");
                    showNotification("Sending invitation...");
                    
                    // Send the email
                    gapi.client.gmail.users.messages.send({
                        'userId': 'me',
                        'resource': {
                            'raw': encodedEmail
                        }
                    }).then(response => {
                        console.log('Email sent successfully:', response);
                        showNotification(`Invitation sent to ${to}`);
                    }).catch(error => {
                        console.error('Error sending email:', error);
                        showNotification(`Failed to send invitation to ${to}: ${error.message}`);
                    });
                } catch (error) {
                    console.error("Error encoding email:", error);
                    showNotification("Error preparing email: " + error.message);
                }
            }
        }
        
        // Copy to clipboard
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification("Link copied to clipboard!");
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        };
        
        // Toggle password visibility
        window.togglePasswordVisibility = function(inputId) {
            const input = document.getElementById(inputId);
            const toggleBtn = input.nextElementSibling;
            
            if (input.type === "password") {
                input.type = "text";
                toggleBtn.textContent = "Hide";
            } else {
                input.type = "password";
                toggleBtn.textContent = "Show";
            }
        };
        
        // Manage league functionality
        window.manageLeague = function(leagueId) {
            // Redirect to a league management page
            window.location.href = `manage-league-details.html?id=${leagueId}`;
        };

        // Add manager to invite list
        window.addManager = function() {
            const managerEmail = document.getElementById('manager-email').value.trim();
            
            if (!managerEmail || !validateEmail(managerEmail)) {
                showNotification("Please enter a valid email address");
                return;
            }
            
            if (invitedManagers.some(m => m.email === managerEmail)) {
                showNotification("This email has already been added");
                return;
            }
            
            invitedManagers.push({
                email: managerEmail,
                invitedAt: new Date().toISOString()
            });
            
            renderManagersList();
            document.getElementById('manager-email').value = '';
        };
        
        // Remove manager from invite list
        window.removeManager = function(index) {
            invitedManagers.splice(index, 1);
            renderManagersList();
        };
        
        // Render managers list
        function renderManagersList() {
            const managersListEl = document.getElementById('managers-list');
            managersListEl.innerHTML = '';
            
            invitedManagers.forEach((manager, index) => {
                const managerItem = document.createElement('div');
                managerItem.className = 'manager-item';
                managerItem.innerHTML = `
                    <div>${manager.email}</div>
                    <button type="button" class="remove-btn" onclick="removeManager(${index})">Remove</button>
                `;
                managersListEl.appendChild(managerItem);
            });
        }
        
        // Generate a random league code
        function generateLeagueCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed similar looking characters
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Validate email format
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after animation completes
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Tab navigation
        window.openTab = function(evt, tabName) {
            var i, tabcontent, tablinks;
            
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            
            // If evt is null, this was programmatically called
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                // Find the tab button for this tab and make it active
                for (i = 0; i < tablinks.length; i++) {
                    if (tablinks[i].getAttribute('onclick').includes(tabName)) {
                        tablinks[i].className += " active";
                        break;
                    }
                }
            }
        };

        // Make functions available in window context for HTML onclick handlers
        window.findLeagueByCode = findLeagueByCode;
        window.joinFoundLeague = joinFoundLeague;
        window.acceptInvitation = acceptInvitation;
        window.declineInvitation = declineInvitation;
        window.copyToClipboard = copyToClipboard;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.manageLeague = manageLeague;
        window.addManager = addManager;
        window.removeManager = removeManager;
        window.openTab = openTab;
    </script>

    <script src="gmailConfig.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>