<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Hockey League</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #0055a4; /* Slightly lighter blue */
            --accent-color: #ffd700; /* Gold */
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --light-text: #f8f9fa;
            --border-color: #dee2e6;
            --hover-bg: #e9ecef;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            color: var(--dark-text);
            background-color: var(--light-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        h1, h2, h3 {
            margin-top: 0;
        }
        .standings-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .standings-table {
            flex: 1;
            min-width: 300px;
        }
        .standings-chart {
            flex: 2;
            min-width: 500px;
            height: 400px;
        }
        .table-container {
            overflow-x: auto; /* Horizontal scroll on small screens */
            max-height: 450px; /* Max height */
            overflow-y: auto; /* Vertical scroll */
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            background-color: #fff;
            margin-bottom: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }
        th, td {
            padding: 0.6rem 0.75rem;
            border: none;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        th {
            background-color: var(--light-bg);
            position: sticky;
            top: 0;
            font-weight: 600;
            z-index: 1;
        }
        th:hover {
            background-color: var(--hover-bg);
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: var(--hover-bg);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .standings-container {
                flex-direction: column;
            }
            .standings-chart {
                min-width: 100%;
            }
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            .league-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .league-actions {
                margin-top: 1rem;
                width: 100%;
                justify-content: center;
            }
            .tabs {
                flex-wrap: wrap;
            }
            .tab {
                flex-grow: 1;
                text-align: center;
                margin-bottom: 5px;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 10px;
            }
            th, td {
                font-size: 0.8rem;
                padding: 0.5rem 0.6rem;
            }
            .hide-mobile {
                display: none;
            }
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #003366;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .player-detail {
            margin-top: 30px;
        }
        .last-updated {
            font-style: italic;
            text-align: right;
            margin-top: 20px;
            color: #666;
        }
        .live-indicator {
            background-color: #ff4136;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
            animation: pulse 2s infinite;
            display: none;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .nav-links {
            margin-top: 20px;
            text-align: center;
        }
        .nav-links a {
            margin: 0 10px;
            color: #003366;
            text-decoration: none;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .auth-container {
            text-align: right;
            padding: 10px 20px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }
        .league-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .league-details h2 {
            margin-bottom: 5px;
        }
        .league-details p {
            color: #666;
            margin-top: 0;
        }
        .league-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            text-decoration: none;
            border: 1px solid var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        .btn.secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn.secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .btn.danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn.danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .members-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .member-item {
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #333;
            color: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideInOut 5s ease-in-out forwards;
        }
        @keyframes slideInOut {
            0% { transform: translateX(100%); opacity: 0; }
            10% { transform: translateX(0); opacity: 1; }
            90% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        .hidden {
            display: none;
        }
        
        /* New styles for team roster view */
        .team-selector {
            margin-bottom: 20px;
        }
        .team-selector select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 200px;
        }
        .roster-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .position-group {
            flex: 1;
            min-width: 300px;
            margin-bottom: 20px;
        }
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #003366;
            color: white;
            padding: 10px;
            border-radius: 4px 4px 0 0;
        }
        .position-count {
            font-weight: bold;
            background-color: white;
            color: #003366;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .position-players {
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            overflow: hidden;
        }
        .player-card {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        .player-card:last-child {
            border-bottom: none;
        }
        .player-card:hover {
            background-color: #f8f8f8;
        }
        .player-info {
            flex: 1;
        }
        .player-name {
            font-weight: bold;
        }
        .player-team {
            color: #666;
            font-size: 0.9em;
        }
        .player-stats {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .player-points {
            font-weight: bold;
            color: #003366;
            font-size: 1.1em;
        }
        .eliminated-player {
            text-decoration: line-through;
            color: #999;
        }
        .player-actions {
            margin-left: 10px;
        }
        .elimyination-btn {
            font-size: 12px;
            padding: 3px 8px;
        }
        .summary-stats {
            background-color: #f9f9f9;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .summary-stat {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #003366;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Player breakdown styles */
        .player-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .breakdown-chart {
            flex: 2;
            min-width: 500px;
            height: 400px;
        }
        .breakdown-table {
            flex: 1;
            min-width: 300px;
        }
        
        /* Team breakdown styles */
        .team-breakdown {
            margin-top: 20px;
        }
        .position-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .position-summary-card {
            flex: 1;
            min-width: 100px;
            background-color: #f8f8f8;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            border: 1px solid #eee;
        }
        .position-summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #003366;
        }
        
        /* Commissioner controls */
        .commissioner-controls {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .commissioner-title {
            color: #856404;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .multi-select-container {
            margin-top: 10px;
        }
        .multi-select-container select {
            width: 100%;
            padding: 8px;
            height: 120px;
        }
        .control-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        /* Loading spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #003366;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .position-group {
                min-width: 100%;
            }
            .breakdown-chart,
            .breakdown-table,
            .standings-table,
            .standings-chart {
                min-width: 100%;
            }
            .tabs {
                flex-wrap: wrap;
            }
            .tab {
                flex-grow: 1;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="auth-container">
        <button id="login-btn">Sign in with Google</button>
        <button id="logout-btn" class="hidden">Sign Out</button>
        <span id="auth-status">You are not signed in</span>
    </div>

    <header>
        <div class="header-content">
            <h1>Fantasy Hockey <span id="liveIndicator" class="live-indicator">LIVE</span></h1>
            <div>
                <a href="manage-leagues.html" class="btn">My Leagues</a>
            </div>
        </div>
    </header>
    
    <div class="container" id="content-container">
        <div id="loading-message">Loading league data...</div>
        
        <div id="league-container" class="hidden">
            <div class="league-info">
                <div class="league-details">
                    <h2 id="league-name">League Name</h2>
                    <p id="league-description">League description goes here</p>
                    <div class="members-list" id="members-list">
                        <!-- Members will be populated here -->
                    </div>
                </div>
                <div class="league-actions">
                    <a href="#" id="draft-link" class="btn">Go to Draft</a>
                    <a href="manage-leagues.html" class="btn">Back to My Leagues</a>
                </div>
            </div>
            
            <!-- Commissioner Controls - Only visible to commissioners -->
            <div id="commissioner-controls" class="commissioner-controls hidden">
                <div class="commissioner-title">Commissioner Controls</div>
                <p>As commissioner, you can manage player eliminations and other league settings.</p>
                
                <div class="multi-select-container">
                    <label for="elimination-team">Mark players as eliminated by team:</label>
                    <select id="elimination-team" multiple size="5">
                        <!-- NHL Teams will be populated here -->
                    </select>
                </div>
                <div class="control-actions">
                    <button id="mark-eliminated-btn" class="btn">Mark Selected Teams Eliminated</button>
                    <button id="restore-eliminated-btn" class="btn secondary">Restore Selected Teams</button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="standings">Standings</div>
                <div class="tab" data-tab="team-roster">Team Roster</div>
                <div class="tab" data-tab="player-stats">Player Stats</div>
                <div class="tab" data-tab="team-breakdown">Team Breakdown</div>
            </div>
            
            <div id="standings" class="tab-content active">
                <div class="standings-container">
                    <div class="standings-table">
                        <h2>Current Standings</h2>
                        <table id="standingsTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Team</th>
                                    <th>F</th>
                                    <th>D</th>
                                    <th>G</th>
                                    <th>Total</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody id="standingsTableBody">
                                <!-- Standings data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="standings-chart">
                        <canvas id="standingsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="team-roster" class="tab-content">
                <h2>Team Roster</h2>
                
                <div class="team-selector">
                    <label for="roster-team-select">Select Team: </label>
                    <select id="roster-team-select" onchange="loadTeamRoster()">
                        <!-- Team options will be added here -->
                    </select>
                </div>
                
                <div class="summary-stats" id="team-summary">
                    <div class="summary-stat">
                        <div class="stat-value" id="total-players">0</div>
                        <div class="stat-label">Total Players</div>
                    </div>
                    <div class="summary-stat">
                        <div class="stat-value" id="active-players">0</div>
                        <div class="stat-label">Active Players</div>
                    </div>
                    <div class="summary-stat">
                        <div class="stat-value" id="total-points">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                </div>
                
                <div class="position-summary">
                    <div class="position-summary-card">
                        <div class="position-summary-value" id="forwards-count">0</div>
                        <div class="stat-label">Forwards</div>
                    </div>
                    <div class="position-summary-card">
                        <div class="position-summary-value" id="defense-count">0</div>
                        <div class="stat-label">Defense</div>
                    </div>
                    <div class="position-summary-card">
                        <div class="position-summary-value" id="goalies-count">0</div>
                        <div class="stat-label">Goalies</div>
                    </div>
                </div>
                
                <div class="roster-container" id="roster-container">
                    <!-- Position groups will be populated here -->
                    <div class="position-group">
                        <div class="position-header">
                            <h3>Forwards</h3>
                            <span class="position-count" id="forwards-active-count">0</span>
                        </div>
                        <div class="position-players" id="forwards-list">
                            <!-- Forward players will be added here -->
                        </div>
                    </div>
                    
                    <div class="position-group">
                        <div class="position-header">
                            <h3>Defense</h3>
                            <span class="position-count" id="defense-active-count">0</span>
                        </div>
                        <div class="position-players" id="defense-list">
                            <!-- Defense players will be added here -->
                        </div>
                    </div>
                    
                    <div class="position-group">
                        <div class="position-header">
                            <h3>Goalies</h3>
                            <span class="position-count" id="goalies-active-count">0</span>
                        </div>
                        <div class="position-players" id="goalies-list">
                            <!-- Goalie players will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="player-stats" class="tab-content">
                <h2>Player Statistics</h2>
                <table id="playerTable">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>NHL Team</th>
                            <th>Fantasy Team</th>
                            <th>Pos</th>
                            <th>Total Points</th>
                            <th>Goals</th>
                            <th>Assists</th>
                            <th>Wins</th>
                            <th>Shutouts</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="playerTableBody">
                        <!-- Player data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div id="team-breakdown" class="tab-content">
                <h2>Team Points Breakdown</h2>
                
                <div class="team-selector">
                    <label for="breakdown-team-select">Select Team: </label>
                    <select id="breakdown-team-select" onchange="loadTeamBreakdown()">
                        <!-- Team options will be added here -->
                    </select>
                </div>
                
                <div class="player-breakdown">
                    <div class="breakdown-chart">
                        <canvas id="playerBreakdownChart"></canvas>
                    </div>
                    <div class="breakdown-table">
                        <h3>Top Contributors</h3>
                        <table id="contributorsTable">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Pos</th>
                                    <th>Points</th>
                                </tr>
                            </thead>
                            <tbody id="contributorsTableBody">
                                <!-- Top contributors will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <h3>Team Points by Position</h3>
                <canvas id="positionBreakdownChart" height="200"></canvas>
            </div>
            
            <div class="last-updated">
                Last updated: <span id="lastUpdatedTime">Loading...</span>
            </div>
        </div>
        
        <div id="no-access-container" class="hidden">
            <h2>Access Denied</h2>
            <p>You don't have access to this league. Please join the league first.</p>
            <div>
                <a href="manage-leagues.html" class="btn">Go to My Leagues</a>
            </div>
        </div>
    </div>
    
    <script src="firebaseConfig.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, get, onValue, update, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase configuration will be injected by GitHub Actions
        const firebaseConfig = {
            apiKey: "PLACEHOLDER",
            authDomain: "playofffantasyhockey.firebaseapp.com",
            databaseURL: "https://playofffantasyhockey-default-rtdb.firebaseio.com",
            projectId: "playofffantasyhockey",
            storageBucket: "playofffantasyhockey.appspot.com",
            messagingSenderId: "PLACEHOLDER",
            appId: "PLACEHOLDER"
        };

        // Initialize Firebase
        const app = initializeApp(window.firebaseConfig || firebaseConfig);
        const auth = getAuth();
        const provider = new GoogleAuthProvider();
        const database = getDatabase();
        
        // Global variables
        let currentUser = null;
        let leagueId = null;
        let leagueData = null;
        let draftedPlayers = [];
        let playerStats = {};
        let playerStatsByID = {};
        let teamRosters = {};
        let teamStats = {};
        let isLiveGame = false;
        let chartObjects = {};
        let isCommissioner = false;
        let eliminatedPlayers = new Set();
        let nhlTeams = {
            'ANA': 'Anaheim Ducks',
            'BOS': 'Boston Bruins',
            'BUF': 'Buffalo Sabres',
            'CGY': 'Calgary Flames',
            'CAR': 'Carolina Hurricanes',
            'CHI': 'Chicago Blackhawks',
            'COL': 'Colorado Avalanche',
            'CBJ': 'Columbus Blue Jackets',
            'DAL': 'Dallas Stars',
            'DET': 'Detroit Red Wings',
            'EDM': 'Edmonton Oilers',
            'FLA': 'Florida Panthers',
            'LAK': 'Los Angeles Kings',
            'MIN': 'Minnesota Wild',
            'MTL': 'Montreal Canadiens',
            'NSH': 'Nashville Predators',
            'NJD': 'New Jersey Devils',
            'NYI': 'New York Islanders',
            'NYR': 'New York Rangers',
            'OTT': 'Ottawa Senators',
            'PHI': 'Philadelphia Flyers',
            'PIT': 'Pittsburgh Penguins',
            'SJS': 'San Jose Sharks',
            'SEA': 'Seattle Kraken',
            'STL': 'St. Louis Blues',
            'TBL': 'Tampa Bay Lightning',
            'TOR': 'Toronto Maple Leafs',
            'VAN': 'Vancouver Canucks',
            'VGK': 'Vegas Golden Knights',
            'WSH': 'Washington Capitals',
            'WPG': 'Winnipeg Jets',
            'UTA': 'Utah Hockey Club'
        };
        
        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authStatus = document.getElementById('auth-status');
        const contentContainer = document.getElementById('content-container');
        const loadingMessage = document.getElementById('loading-message');
        const leagueContainer = document.getElementById('league-container');
        const noAccessContainer = document.getElementById('no-access-container');
        const leagueNameEl = document.getElementById('league-name');
        const leagueDescriptionEl = document.getElementById('league-description');
        const membersListEl = document.getElementById('members-list');
        const draftLinkEl = document.getElementById('draft-link');
        const commissionerControlsEl = document.getElementById('commissioner-controls');
        
        // Check for league ID in URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('id')) {
            leagueId = urlParams.get('id');
        }
        
        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                authStatus.textContent = `Signed in as ${user.displayName}`;
                
                // Load league data if we have an ID
                if (leagueId) {
                    loadLeagueData();
                } else {
                    loadingMessage.textContent = "No league selected. Please select a league from 'My Leagues'.";
                }
            } else {
                // User is signed out
                currentUser = null;
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                authStatus.textContent = 'You are not signed in';
                
                // Hide content when signed out
                leagueContainer.classList.add('hidden');
                noAccessContainer.classList.add('hidden');
                loadingMessage.textContent = "Please sign in to view league data.";
            }
        });
        
        // Sign in with Google
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    // User signed in
                    console.log("User signed in:", result.user);
                }).catch((error) => {
                    // Handle errors
                    console.error("Auth error:", error);
                    showNotification(`Error: ${error.message}`);
                });
        });
        
        // Sign out
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log("User signed out");
            }).catch((error) => {
                console.error("Sign out error:", error);
            });
        });
        
        // Load league data
        function loadLeagueData() {
            if (!currentUser || !leagueId) return;
            
            loadingMessage.textContent = "Loading league data...";
            
            // Get league data
            const leagueRef = ref(database, `leagues/${leagueId}`);
            get(leagueRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    throw new Error("League not found");
                }
                
                leagueData = snapshot.val();
                
                // Check if user has access to this league
                if (!leagueData.teams || !leagueData.teams[currentUser.uid]) {
                    loadingMessage.classList.add('hidden');
                    noAccessContainer.classList.remove('hidden');
                    return;
                }
                
                // Check if user is commissioner
                isCommissioner = leagueData.teams[currentUser.uid].isCommissioner || false;
                
                // Update league info
                updateLeagueInfo();
                
                // Load player stats first
                loadPlayerStats().then(() => {
                    // Load drafted players data
                    loadDraftedPlayers();
                    
                    // Show league container
                    loadingMessage.classList.add('hidden');
                    leagueContainer.classList.remove('hidden');
                    
                    // Set up live game checker
                    checkLiveGames();
                    setInterval(checkLiveGames, 60000); // Check every minute
                    
                    // Set up refresh timer for stats
                    setInterval(loadDraftedPlayers, 300000); // Refresh every 5 minutes
                    
                    // Show commissioner controls if applicable
                    if (isCommissioner) {
                        commissionerControlsEl.classList.remove('hidden');
                        populateNHLTeamsSelector();
                        setupCommissionerControls();
                    }
                }).catch(error => {
                    console.error("Error loading player stats:", error);
                    showNotification(`Error loading player stats: ${error.message}`);
                });
            }).catch(error => {
                console.error("Error loading league:", error);
                loadingMessage.textContent = `Error: ${error.message}`;
            });
        }
        
        // Load player stats from updatedstats JSON file
        async function loadPlayerStats() {
            try {
                // Try to load the most recent stats file first
                const now = new Date();
                const currentDate = now.toLocaleString('en-us', { month: 'short', day: '2-digit' }).replace(' ', '');
                
                // Use raw GitHub URL instead of relative path, but keep the dynamic date
                const rawGitHubBaseUrl = 'https://raw.githubusercontent.com/randyj18/Fantasy_Hockey/master/data/';
                const latestStatsFile = `${rawGitHubBaseUrl}updatedstats-${currentDate}.json`;
                
                let response = await fetch(latestStatsFile);
                
                // If today's file doesn't exist, try yesterday's file
                if (!response.ok) {
                    console.warn(`Stats file for today not found, trying yesterday's file`);
                    
                    // Calculate yesterday's date
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayDate = yesterday.toLocaleString('en-us', { month: 'short', day: '2-digit' }).replace(' ', '');
                    
                    // Try yesterday's file
                    const yesterdayStatsFile = `${rawGitHubBaseUrl}updatedstats-${yesterdayDate}.json`;
                    response = await fetch(yesterdayStatsFile);
                    
                    // If yesterday's file also doesn't exist, use empty stats
                    if (!response.ok) {
                        console.warn(`No recent stats files found, using empty stats`);
                        playerStats = {};
                        playerStatsByID = {};
                        return {};
                    }
                }
                
                const data = await response.json();
                
                // Process player stats
                playerStats = {};
                playerStatsByID = {};
                
                // Process array format (updatedstats-*.json)
                data.forEach(player => {
                    const id = player["Player ID"] || player.playerId;
                    
                    if (!id) {
                        console.warn("Player without ID:", player);
                        return;
                    }
                    
                    // Extract stats from player data - use playoff stats only
                    playerStats[id] = {
                        goals: player.Goals || 0,
                        assists: player.Assists || 0,
                        wins: player.Wins || 0,
                        shutouts: player.Shutouts || 0,
                        pointsBeforeAcquiring: player["Points Before Acquiring"] || 0
                    };
                    
                    // Also index by ID for faster lookup
                    playerStatsByID[id] = playerStats[id];
                });
                
                console.log(`Loaded stats for ${Object.keys(playerStats).length} players`);
                return playerStats;
                
            } catch (error) {
                console.error("Error loading player stats:", error);
                // Return empty object so the app can continue with default values
                return {};
            }
        }
        
        // Update league info
        function updateLeagueInfo() {
            // Set league name and description
            leagueNameEl.textContent = leagueData.name;
            leagueDescriptionEl.textContent = leagueData.description || 'No description provided';
            
            // Update draft link
            draftLinkEl.href = `draftcentre.html?league=${leagueId}`;
            
            // Populate members list
            membersListEl.innerHTML = '';
            
            if (leagueData.teams) {
                Object.values(leagueData.teams).forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    
                    // Add commissioner badge if applicable
                    const commissionerBadge = member.isCommissioner ? 
                        '<span class="badge commissioner-badge">Commissioner</span>' : '';
                    
                    memberItem.innerHTML = `${member.name} ${commissionerBadge}`;
                    membersListEl.appendChild(memberItem);
                });
            }
        }
        
        // Load drafted players data
        function loadDraftedPlayers() {
            const draftedPlayersRef = ref(database, `leagues/${leagueId}/draftedPlayers`);
            const eliminatedPlayersRef = ref(database, `leagues/${leagueId}/eliminatedPlayers`);
            
            // Get both drafted players and eliminated players data
            Promise.all([
                get(draftedPlayersRef),
                get(eliminatedPlayersRef)
            ]).then(([draftedSnapshot, eliminatedSnapshot]) => {
                // Process drafted players
                if (draftedSnapshot.exists()) {
                    draftedPlayers = Object.entries(draftedSnapshot.val()).map(([key, player]) => ({
                        ...player,
                        key: key, // Store the Firebase key for reference
                        playerId: player.playerId || key // Use explicit playerId if available, otherwise use the key
                    }));
                } else {
                    draftedPlayers = [];
                }
                
                // Process eliminated players
                eliminatedPlayers = new Set();
                if (eliminatedSnapshot.exists()) {
                    const eliminatedData = eliminatedSnapshot.val();
                    Object.keys(eliminatedData).forEach(playerId => {
                        if (eliminatedData[playerId] === true) {
                            eliminatedPlayers.add(playerId);
                        }
                    });
                }
                
                // Process team rosters
                processTeamRosters();
                
                // Update UI
                populateTeamSelectors();
                updateStandingsTable();
                updateStandingsChart();
                updatePlayerTable();
                loadTeamRoster(); // Load current user's roster initially
                loadTeamBreakdown(); // Load current user's breakdown initially
                
                // Update last updated time
                const now = new Date();
                document.getElementById('lastUpdatedTime').textContent = now.toLocaleString();
                
            }).catch(error => {
                console.error("Error loading drafted players:", error);
                showNotification(`Error: ${error.message}`);
            });
        }
        
        // Process team rosters from drafted players
        function processTeamRosters() {
            teamRosters = {};
            teamStats = {};
            
            // Initialize team data for all teams
            if (leagueData && leagueData.teams) {
                Object.entries(leagueData.teams).forEach(([teamId, teamInfo]) => {
                    teamRosters[teamId] = {
                        teamName: teamInfo.name,
                        forwards: [],
                        defense: [],
                        goalies: []
                    };
                    
                    teamStats[teamId] = {
                        totalPoints: 0,
                        forwardPoints: 0,
                        defensePoints: 0,
                        goaliePoints: 0,
                        playerCount: 0,
                        forwardCount: 0,
                        defenseCount: 0,
                        goalieCount: 0,
                        activePlayerCount: 0,
                        activeForwardCount: 0,
                        activeDefenseCount: 0,
                        activeGoalieCount: 0
                    };
                });
            }
            
            // Organize players by team and position
            draftedPlayers.forEach(player => {
                const teamId = player.teamUid;
                if (!teamRosters[teamId]) {
                    console.warn(`Team ${teamId} not found for player ${player.Player}`);
                    return;
                }
                
                // Get player points from stats or default values
                let playerPoints = calculatePlayerPoints(player);
                
                // Determine player position group
                let positionGroup = 'forwards';
                if (player.Position === 'D') {
                    positionGroup = 'defense';
                } else if (player.Position === 'G') {
                    positionGroup = 'goalies';
                }
                
                // Add player to appropriate position group
                const isEliminated = eliminatedPlayers.has(player.playerId);
                const playerWithStats = {
                    ...player,
                    points: playerPoints,
                    isEliminated: isEliminated
                };
                
                teamRosters[teamId][positionGroup].push(playerWithStats);
                
                // Update team stats
                teamStats[teamId].totalPoints += playerPoints;
                teamStats[teamId].playerCount++;
                
                if (positionGroup === 'forwards') {
                    teamStats[teamId].forwardPoints += playerPoints;
                    teamStats[teamId].forwardCount++;
                    if (!isEliminated) teamStats[teamId].activeForwardCount++;
                } else if (positionGroup === 'defense') {
                    teamStats[teamId].defensePoints += playerPoints;
                    teamStats[teamId].defenseCount++;
                    if (!isEliminated) teamStats[teamId].activeDefenseCount++;
                } else if (positionGroup === 'goalies') {
                    teamStats[teamId].goaliePoints += playerPoints;
                    teamStats[teamId].goalieCount++;
                    if (!isEliminated) teamStats[teamId].activeGoalieCount++;
                }
                
                if (!isEliminated) {
                    teamStats[teamId].activePlayerCount++;
                }
            });
            
            // Sort players in each team by points
            Object.values(teamRosters).forEach(team => {
                team.forwards.sort((a, b) => b.points - a.points);
                team.defense.sort((a, b) => b.points - a.points);
                team.goalies.sort((a, b) => b.points - a.points);
            });
        }
        
        // Calculate player points from stats
        function calculatePlayerPoints(player) {
            // Get player ID
            const playerId = player.playerId;
            const position = player.Position;
            let points = 0;
            
            // Get player stats from our stats object
            const playerStat = playerStatsByID[playerId];
            
            if (playerStat) {
                // Use playoff stats from the stats file
                if (position === 'G') {
                    // For goalies: wins = 2pts, shutouts = 2pts
                    points = (playerStat.wins * 2) + (playerStat.shutouts * 2);
                } else {
                    // For skaters: goals = 1pt, assists = 1pt
                    points = playerStat.goals + playerStat.assists;
                }
                
                // Account for points before acquiring (for players added after initial draft)
                if (playerStat.pointsBeforeAcquiring) {
                    points += playerStat.pointsBeforeAcquiring;
                }
            } else {
                // If no stats found, default to zero instead of using regular season stats
                // This ensures we only show playoff stats
                console.warn(`No playoff stats found for player ${player.Player} (ID: ${playerId}), using zeros`);
            }
            
            return points;
        }
        
        // Populate team selectors in different tabs
        function populateTeamSelectors() {
            const rosterSelect = document.getElementById('roster-team-select');
            const breakdownSelect = document.getElementById('breakdown-team-select');
            
            // Clear existing options
            rosterSelect.innerHTML = '';
            breakdownSelect.innerHTML = '';
            
            // Add options for each team
            let userTeamOption = null;
            
            if (leagueData && leagueData.teams) {
                // Sort teams alphabetically
                const sortedTeams = Object.entries(leagueData.teams)
                    .sort(([, a], [, b]) => a.name.localeCompare(b.name));
                
                sortedTeams.forEach(([teamId, team]) => {
                    const option = document.createElement('option');
                    option.value = teamId;
                    option.textContent = team.name;
                    
                    // Create clones for each select
                    const rosterOption = option.cloneNode(true);
                    const breakdownOption = option.cloneNode(true);
                    
                    rosterSelect.appendChild(rosterOption);
                    breakdownSelect.appendChild(breakdownOption);
                    
                    // Save user's team option for setting initial selection
                    if (teamId === currentUser.uid) {
                        userTeamOption = {
                            id: teamId,
                            name: team.name
                        };
                    }
                });
            }
            
            // Set initial selections to user's team
            if (userTeamOption) {
                rosterSelect.value = userTeamOption.id;
                breakdownSelect.value = userTeamOption.id;
            }
        }
        // Update the standings table
        function updateStandingsTable() {
            const tableBody = document.getElementById('standingsTableBody');
            tableBody.innerHTML = '';
            
            if (!teamStats || Object.keys(teamStats).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No data available</td></tr>';
                return;
            }
            
            // Sort teams by total points
            const sortedTeams = Object.entries(teamStats)
                .sort(([, a], [, b]) => b.totalPoints - a.totalPoints);
            
            // Add each team to the table
            sortedTeams.forEach(([teamId, stats], index) => {
                const teamName = leagueData.teams[teamId]?.name || 'Unknown Team';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${teamName}</td>
                    <td>${stats.activeForwardCount}/${stats.forwardCount}</td>
                    <td>${stats.activeDefenseCount}/${stats.defenseCount}</td>
                    <td>${stats.activeGoalieCount}/${stats.goalieCount}</td>
                    <td>${stats.activePlayerCount}/${stats.playerCount}</td>
                    <td>${stats.totalPoints}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Update the standings chart
        function updateStandingsChart() {
            const ctx = document.getElementById('standingsChart').getContext('2d');
            
            if (!teamStats || Object.keys(teamStats).length === 0) {
                return;
            }
            
            // Sort teams by total points
            const sortedTeams = Object.entries(teamStats)
                .sort(([, a], [, b]) => b.totalPoints - a.totalPoints);
            
            const teamNames = sortedTeams.map(([teamId]) => 
                leagueData.teams[teamId]?.name || 'Unknown Team'
            );
            
            const data = {
                labels: teamNames,
                datasets: [{
                    label: 'Total Points',
                    data: sortedTeams.map(([, stats]) => stats.totalPoints),
                    backgroundColor: 'rgba(0, 51, 102, 0.7)',
                    borderColor: 'rgba(0, 51, 102, 1)',
                    borderWidth: 1
                }]
            };
            
            // Destroy existing chart if it exists
            if (chartObjects.standings) {
                chartObjects.standings.destroy();
            }
            
            // Create new chart
            chartObjects.standings = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Update the player stats table
        function updatePlayerTable() {
            const tableBody = document.getElementById('playerTableBody');
            tableBody.innerHTML = '';
            
            if (!draftedPlayers || draftedPlayers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10">No drafted players available</td></tr>';
                return;
            }
            
            // Sort players by points
            const sortedPlayers = [...draftedPlayers]
                .sort((a, b) => calculatePlayerPoints(b) - calculatePlayerPoints(a));
            
            // Add each player to the table
            sortedPlayers.forEach(player => {
                const points = calculatePlayerPoints(player);
                const isEliminated = eliminatedPlayers.has(player.playerId);
                const teamName = leagueData.teams[player.teamUid]?.name || 'Unknown Team';
                
                // Get player stats
                const playerStat = playerStatsByID[player.playerId] || {};
                const isGoalie = player.Position === 'G';
                
                // Get actual stats from playerStat or default to 0
                const goals = isGoalie ? '-' : (playerStat.goals || 0);
                const assists = isGoalie ? '-' : (playerStat.assists || 0);
                const wins = isGoalie ? (playerStat.wins || 0) : '-';
                const shutouts = isGoalie ? (playerStat.shutouts || 0) : '-';
                
                const row = document.createElement('tr');
                row.classList.toggle('eliminated-player', isEliminated);
                
                row.innerHTML = `
                    <td>${player.Player}</td>
                    <td>${player['NHL Team']}</td>
                    <td>${teamName}</td>
                    <td>${player.Position}</td>
                    <td>${points}</td>
                    <td>${goals}</td>
                    <td>${assists}</td>
                    <td>${wins}</td>
                    <td>${shutouts}</td>
                    <td>${isEliminated ? 'Eliminated' : 'Active'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Load team roster for selected team
        window.loadTeamRoster = function() {
            const teamId = document.getElementById('roster-team-select').value;
            
            if (!teamId || !teamRosters[teamId]) {
                console.error('Team not found:', teamId);
                return;
            }
            
            const team = teamRosters[teamId];
            const stats = teamStats[teamId];
            
            // Update team summary stats
            document.getElementById('total-players').textContent = stats.playerCount;
            document.getElementById('active-players').textContent = stats.activePlayerCount;
            document.getElementById('total-points').textContent = stats.totalPoints;
            
            // Update position counts
            document.getElementById('forwards-count').textContent = `${stats.activeForwardCount}/${stats.forwardCount}`;
            document.getElementById('defense-count').textContent = `${stats.activeDefenseCount}/${stats.defenseCount}`;
            document.getElementById('goalies-count').textContent = `${stats.activeGoalieCount}/${stats.goalieCount}`;
            
            document.getElementById('forwards-active-count').textContent = `${stats.activeForwardCount}/${stats.forwardCount}`;
            document.getElementById('defense-active-count').textContent = `${stats.activeDefenseCount}/${stats.defenseCount}`;
            document.getElementById('goalies-active-count').textContent = `${stats.activeGoalieCount}/${stats.goalieCount}`;
            
            // Populate position lists
            populatePositionList('forwards-list', team.forwards, teamId);
            populatePositionList('defense-list', team.defense, teamId);
            populatePositionList('goalies-list', team.goalies, teamId);
        };
        
        // Populate a position list with players
        function populatePositionList(elementId, players, teamId) {
            const list = document.getElementById(elementId);
            list.innerHTML = '';
            
            if (players.length === 0) {
                list.innerHTML = '<div class="player-card">No players drafted for this position</div>';
                return;
            }
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                if (player.isEliminated) {
                    playerCard.classList.add('eliminated-player');
                }
                
                // Get player stats for display
                const playerStat = playerStatsByID[player.playerId] || {};
                const isGoalie = player.Position === 'G';
                let statsDisplay = '';
                
                if (isGoalie) {
                    const wins = playerStat.wins || 0;
                    const shutouts = playerStat.shutouts || 0;
                    statsDisplay = `W: ${wins}, SO: ${shutouts}`;
                } else {
                    const goals = playerStat.goals || 0;
                    const assists = playerStat.assists || 0;
                    statsDisplay = `G: ${goals}, A: ${assists}`;
                }
                
                // Determine if commissioner controls should be shown
                const showControls = isCommissioner;
                let controlButton = '';
                
                if (showControls) {
                    if (player.isEliminated) {
                        controlButton = `<button class="btn secondary elimyination-btn" data-player-id="${player.playerId}" onclick="restorePlayer('${player.playerId}')">Restore</button>`;
                    } else {
                        controlButton = `<button class="btn danger elimyination-btn" data-player-id="${player.playerId}" onclick="eliminatePlayer('${player.playerId}')">Eliminate</button>`;
                    }
                }
                
                playerCard.innerHTML = `
                    <div class="player-info">
                        <div class="player-name">${player.Player}</div>
                        <div class="player-team">${player['NHL Team']} - ${player.Position}</div>
                        <div class="player-team">${statsDisplay}</div>
                    </div>
                    <div class="player-stats">
                        <div class="player-points">${player.points} pts</div>
                        ${showControls ? `<div class="player-actions">${controlButton}</div>` : ''}
                    </div>
                `;
                
                list.appendChild(playerCard);
            });
        }
        
        // Load team breakdown for selected team
        window.loadTeamBreakdown = function() {
            const teamId = document.getElementById('breakdown-team-select').value;
            
            if (!teamId || !teamRosters[teamId]) {
                console.error('Team not found:', teamId);
                return;
            }
            
            const team = teamRosters[teamId];
            const stats = teamStats[teamId];
            
            // Update player breakdown chart
            updatePlayerBreakdownChart(team, teamId);
            
            // Update position breakdown chart
            updatePositionBreakdownChart(stats);
            
            // Update top contributors table
            updateContributorsTable(team, teamId);
        };
        
        // Update player breakdown chart
        function updatePlayerBreakdownChart(team, teamId) {
            const ctx = document.getElementById('playerBreakdownChart').getContext('2d');
            
            // Combine all players from different positions
            const allPlayers = [
                ...team.forwards,
                ...team.defense,
                ...team.goalies
            ].sort((a, b) => b.points - a.points);
            
            // Take top 10 players for clarity
            const topPlayers = allPlayers.slice(0, 10);
            
            const data = {
                labels: topPlayers.map(p => p.Player),
                datasets: [{
                    label: 'Points',
                    data: topPlayers.map(p => p.points),
                    backgroundColor: topPlayers.map(p => {
                        if (p.isEliminated) {
                            return 'rgba(108, 117, 125, 0.6)'; // Grey for eliminated
                        }
                        if (p.Position === 'G') {
                            return 'rgba(255, 99, 132, 0.6)'; // Red for goalies
                        } else if (p.Position === 'D') {
                            return 'rgba(54, 162, 235, 0.6)'; // Blue for defense
                        } else {
                            return 'rgba(75, 192, 192, 0.6)'; // Teal for forwards
                        }
                    }),
                    borderColor: topPlayers.map(p => {
                        if (p.isEliminated) {
                            return 'rgba(108, 117, 125, 1)';
                        }
                        if (p.Position === 'G') {
                            return 'rgba(255, 99, 132, 1)';
                        } else if (p.Position === 'D') {
                            return 'rgba(54, 162, 235, 1)';
                        } else {
                            return 'rgba(75, 192, 192, 1)';
                        }
                    }),
                    borderWidth: 1
                }]
            };
            
            // Destroy existing chart if it exists
            if (chartObjects.playerBreakdown) {
                chartObjects.playerBreakdown.destroy();
            }
            
            // Create new chart
            chartObjects.playerBreakdown = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => {
                                    const index = tooltipItems[0].dataIndex;
                                    return topPlayers[index].Player;
                                },
                                label: (tooltipItem) => {
                                    const index = tooltipItem.dataIndex;
                                    const player = topPlayers[index];
                                    return [
                                        `Points: ${player.points}`,
                                        `Position: ${player.Position}`,
                                        `Team: ${player['NHL Team']}`,
                                        `Status: ${player.isEliminated ? 'Eliminated' : 'Active'}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Points'
                            }
                        }
                    }
                }
            });
        }
        // Update position breakdown chart
        function updatePositionBreakdownChart(stats) {
            const ctx = document.getElementById('positionBreakdownChart').getContext('2d');
            
            const data = {
                labels: ['Forwards', 'Defense', 'Goalies'],
                datasets: [{
                    label: 'Points by Position',
                    data: [stats.forwardPoints, stats.defensePoints, stats.goaliePoints],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 99, 132, 0.6)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            
            // Destroy existing chart if it exists
            if (chartObjects.positionBreakdown) {
                chartObjects.positionBreakdown.destroy();
            }
            
            // Create new chart
            chartObjects.positionBreakdown = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (tooltipItem) => {
                                    const label = tooltipItem.label;
                                    const value = tooltipItem.raw;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} points (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update top contributors table
        function updateContributorsTable(team, teamId) {
            const tableBody = document.getElementById('contributorsTableBody');
            tableBody.innerHTML = '';
            
            // Combine all players from different positions
            const allPlayers = [
                ...team.forwards,
                ...team.defense,
                ...team.goalies
            ].sort((a, b) => b.points - a.points);
            
            // Take top 10 players for the table
            const topPlayers = allPlayers.slice(0, 10);
            
            if (topPlayers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">No players drafted</td></tr>';
                return;
            }
            
            topPlayers.forEach(player => {
                const row = document.createElement('tr');
                if (player.isEliminated) {
                    row.classList.add('eliminated-player');
                }
                
                row.innerHTML = `
                    <td>${player.Player}</td>
                    <td>${player.Position}</td>
                    <td>${player.points}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Check if any games are currently live
        function checkLiveGames() {
            try {
                // Check NHL API for active games
                fetch('https://api-web.nhle.com/v1/schedule/now')
                    .then(response => response.json())
                    .then(data => {
                        // Check if there are any active games
                        isLiveGame = data.gameWeek && 
                                     data.gameWeek.some(day => 
                                         day.games && day.games.some(game => 
                                             game.gameState === 'LIVE' || game.gameState === 'PREVIEW'
                                         )
                                     );
                        
                        // Show/hide live indicator
                        const liveIndicator = document.getElementById('liveIndicator');
                        liveIndicator.style.display = isLiveGame ? 'inline-block' : 'none';
                        
                        // If games are live, refresh data more frequently
                        if (isLiveGame) {
                            loadPlayerStats().then(() => {
                                loadDraftedPlayers();
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error checking live games:', error);
                        isLiveGame = false;
                        document.getElementById('liveIndicator').style.display = 'none';
                    });
            } catch (error) {
                console.error('Error checking live games:', error);
                isLiveGame = false;
                document.getElementById('liveIndicator').style.display = 'none';
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after animation completes
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // --- Commissioner Functionality ---
        
        // Populate NHL teams multi-select
        function populateNHLTeamsSelector() {
            const eliminationTeam = document.getElementById('elimination-team');
            eliminationTeam.innerHTML = '';
            
            // Sort team names alphabetically
            const sortedTeams = Object.entries(nhlTeams)
                .sort(([, a], [, b]) => a.localeCompare(b));
            
            sortedTeams.forEach(([abbr, name]) => {
                const option = document.createElement('option');
                option.value = abbr;
                option.textContent = name;
                eliminationTeam.appendChild(option);
            });
        }
        
        // Setup commissioner control buttons
        function setupCommissionerControls() {
            document.getElementById('mark-eliminated-btn').addEventListener('click', markTeamsEliminated);
            document.getElementById('restore-eliminated-btn').addEventListener('click', restoreTeamsEliminated);
        }

        // Eliminate individual player
        window.eliminatePlayer = function(playerId) {
            if (!isCommissioner) {
                showNotification("Only commissioners can perform this action");
                return;
            }
            
            // Find the player
            const player = draftedPlayers.find(p => p.playerId === playerId);
            if (!player) {
                showNotification("Player not found");
                return;
            }
            
            // Update the eliminated player in Firebase
            set(ref(database, `leagues/${leagueId}/eliminatedPlayers/${playerId}`), true)
                .then(() => {
                    showNotification(`${player.Player} marked as eliminated`);
                    loadDraftedPlayers(); // Refresh data
                })
                .catch(error => {
                    console.error("Error eliminating player:", error);
                    showNotification(`Error: ${error.message}`);
                });
        };
        
        // Restore individual player
        window.restorePlayer = function(playerId) {
            if (!isCommissioner) {
                showNotification("Only commissioners can perform this action");
                return;
            }
            
            // Find the player
            const player = draftedPlayers.find(p => p.playerId === playerId);
            if (!player) {
                showNotification("Player not found");
                return;
            }
            
            // Update the eliminated player in Firebase
            set(ref(database, `leagues/${leagueId}/eliminatedPlayers/${playerId}`), null)
                .then(() => {
                    showNotification(`${player.Player} restored`);
                    loadDraftedPlayers(); // Refresh data
                })
                .catch(error => {
                    console.error("Error restoring player:", error);
                    showNotification(`Error: ${error.message}`);
                });
        };
        
        // Mark teams as eliminated
        function markTeamsEliminated() {
            if (!isCommissioner) {
                showNotification("Only commissioners can perform this action");
                return;
            }
            
            const eliminationTeam = document.getElementById('elimination-team');
            const selectedTeams = Array.from(eliminationTeam.selectedOptions).map(option => option.value);
            
            if (selectedTeams.length === 0) {
                showNotification("Please select at least one team to mark as eliminated");
                return;
            }
            
            // Confirm before proceeding
            const teamNames = selectedTeams.map(abbr => nhlTeams[abbr]).join(", ");
            if (!confirm(`Are you sure you want to mark all players from ${teamNames} as eliminated?`)) {
                return;
            }
            
            // Find all players from the selected teams
            const playersToEliminate = draftedPlayers.filter(player => 
                selectedTeams.includes(player['NHL Team']) && !eliminatedPlayers.has(player.playerId)
            );
            
            if (playersToEliminate.length === 0) {
                showNotification("No active players found from the selected teams");
                return;
            }
            
            // Update the eliminated players in Firebase
            const updates = {};
            playersToEliminate.forEach(player => {
                updates[`leagues/${leagueId}/eliminatedPlayers/${player.playerId}`] = true;
            });
            
            update(ref(database), updates)
                .then(() => {
                    showNotification(`${playersToEliminate.length} players marked as eliminated`);
                    loadDraftedPlayers(); // Refresh data
                })
                .catch(error => {
                    console.error("Error marking players as eliminated:", error);
                    showNotification(`Error: ${error.message}`);
                });
        }
        
        // Restore eliminated teams
        function restoreTeamsEliminated() {
            if (!isCommissioner) {
                showNotification("Only commissioners can perform this action");
                return;
            }
            
            const eliminationTeam = document.getElementById('elimination-team');
            const selectedTeams = Array.from(eliminationTeam.selectedOptions).map(option => option.value);
            
            if (selectedTeams.length === 0) {
                showNotification("Please select at least one team to restore");
                return;
            }
            
            // Confirm before proceeding
            const teamNames = selectedTeams.map(abbr => nhlTeams[abbr]).join(", ");
            if (!confirm(`Are you sure you want to restore all players from ${teamNames}?`)) {
                return;
            }
            
            // Find all eliminated players from the selected teams
            const playersToRestore = draftedPlayers.filter(player => 
                selectedTeams.includes(player['NHL Team']) && eliminatedPlayers.has(player.playerId)
            );
            
            if (playersToRestore.length === 0) {
                showNotification("No eliminated players found from the selected teams");
                return;
            }
            
            // Update the eliminated players in Firebase
            const updates = {};
            playersToRestore.forEach(player => {
                updates[`leagues/${leagueId}/eliminatedPlayers/${player.playerId}`] = null;
            });
            
            update(ref(database), updates)
                .then(() => {
                    showNotification(`${playersToRestore.length} players restored`);
                    loadDraftedPlayers(); // Refresh data
                })
                .catch(error => {
                    console.error("Error restoring players:", error);
                    showNotification(`Error: ${error.message}`);
                });
        }

        // Set up tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Refresh charts if needed
                if (tabId === 'team-breakdown') {
                    if (chartObjects.playerBreakdown) chartObjects.playerBreakdown.update();
                    if (chartObjects.positionBreakdown) chartObjects.positionBreakdown.update();
                } else if (tabId === 'standings') {
                    if (chartObjects.standings) chartObjects.standings.update();
                }
            });
        });
        
        // Expose functions to window for inline handlers
        window.loadTeamRoster = loadTeamRoster;
        window.loadTeamBreakdown = loadTeamBreakdown;
        window.eliminatePlayer = eliminatePlayer;
        window.restorePlayer = restorePlayer;
    </script>
    
    <footer>
        <p>&copy; 2025 Fantasy Hockey League | Built with Firebase</p>
        <div class="footer-links">
            <a href="index.html">Home</a>
            <a href="manage-leagues.html">Manage Leagues</a>
            <a href="draftcentre.html">Draft Centre</a>
            <a href="league.html">League Details</a>
        </div>
    </footer>
    
    <style>
        footer {
            background-color: var(--light-bg);
            padding: 15px;
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
        }
        .footer-links {
            margin-top: 10px;
        }
        .footer-links a {
            margin: 0 10px;
            color: var(--primary-color);
            text-decoration: none;
        }
        .footer-links a:hover {
            text-decoration: underline;
        }
    </style>
</body>
</html>